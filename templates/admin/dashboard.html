{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in-up">

    <div class="flex items-center gap-3 mb-8">
        <div class="p-3 bg-white rounded-lg shadow-sm border border-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#123456"
                class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
        </div>
        <div>
            <h1 class="text-3xl font-bold text-[#123456]">Panel de Administración</h1>
            <p class="text-sm text-gray-500">Control central de usuarios, reglas y catálogos.</p>
        </div>
    </div>

    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">

                <button onclick="switchTab('usuarios')" id="tab-usuarios"
                    class="tab-button border-b-2 border-[#00BABB] py-4 px-1 text-sm font-medium text-[#123456] flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 text-[#00BABB]">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    Usuarios y Roles
                </button>

                <button onclick="switchTab('correos')" id="tab-correos"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                    </svg>
                    Configuración de Correos
                </button>

                <button onclick="switchTab('buzones')" id="tab-buzones"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M7.875 14.25l1.214 1.942a2.25 2.25 0 001.908 1.058h2.006c.776 0 1.497-.4 1.908-1.058l1.214-1.942M2.41 9h4.636a2.25 2.25 0 011.872 1.002l.164.246a2.25 2.25 0 001.872 1.002h2.092a2.25 2.25 0 001.872-1.002l.164-.246A2.25 2.25 0 0116.954 9h4.636M2.41 9a2.25 2.25 0 00-.16.832V12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 12V9.832c0-.287-.055-.57-.16-.832M2.41 9a2.25 2.25 0 01.382-.632l3.285-3.832a2.25 2.25 0 011.708-.786h8.43c.657 0 1.281.287 1.709.786l3.284 3.832c.163.19.291.404.382.632M4.5 20.25h15A2.25 2.25 0 0021.75 18v-2.625c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125V18a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                    Buzones de Notificaciones
                </button>

                <button onclick="switchTab('catalogos')" id="tab-catalogos"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    Catálogos
                </button>

                <button onclick="switchTab('config')" id="tab-config"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.159.956c.03.183.137.344.293.438l.956.577c.156.095.345.117.518.062l.945-.301a1.001 1.001 0 011.229.626l.47 1.092a1.001 1.001 0 01-.223 1.209l-.718.69a1.001 1.001 0 000 1.414l.718.69a1.001 1.001 0 01.223 1.209l-.47 1.092a1.001 1.001 0 01-1.229.626l-.945-.301a1.001 1.001 0 00-.518.062l-.956.577a1.001 1.001 0 00-.293.438l-.159.956c-.09.542-.56.94-1.11.94h-1.093c-.55 0-1.02-.398-1.11-.94l-.159-.956c-.03-.183-.137-.344-.293-.438l-.956-.577a1.001 1.001 0 00-.518-.062l-.945.301a1.001 1.001 0 01-1.229-.626l-.47-1.092a1.001 1.001 0 01.223-1.209l.718-.69a1.001 1.001 0 000-1.414l-.718-.69a1.001 1.001 0 01-.223-1.209l.47-1.092a1.001 1.001 0 011.229-.626l.945.301c.173.055.362.033.518-.062l.956-.577c.156-.095.263-.255.293-.438l.159-.956zM12 15a3 3 0 100-6 3 3 0 000 6z" />
                    </svg>
                    Configuración
                </button>
            </nav>
        </div>
    </div>

    <div id="content-usuarios" class="tab-content">
        <div class="bg-[#E0F7F7] border-l-4 border-[#00BABB] p-4 rounded shadow-sm mb-6">
            <h3 class="font-bold text-[#123456] mb-2">Guía de Permisos y Roles:</h3>
            <ul class="text-sm text-[#123456] space-y-1">
                <li><strong>VIEWER:</strong> Solo puede consultar información.</li>
                <li><strong>USER (Editor):</strong> Puede crear y editar sus propios registros.</li>
                <li><strong>MANAGER:</strong> Puede editar y reasignar registros de su equipo.</li>
                <li><strong>ADMIN:</strong> Control total.</li>
            </ul>
        </div>

        <section class="bg-white p-6 rounded-lg shadow border-t-4 border-[#00BABB]">
            <!-- Barra de búsqueda -->
            <div class="mb-4 flex items-center justify-between">
                <div class="flex-1 max-w-md">
                    <div class="relative">
                        <input type="text" id="user-search" placeholder="Buscar usuario por nombre o email..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-[#00BABB] focus:border-[#00BABB] text-sm"
                            oninput="filterUsers()">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="user-count-display">{{ users|length }}</span> usuarios
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Módulos</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Inicio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol de Sistema
                            </th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="users-tbody">
                        {% for u in users %}
                        {% include "admin/partials/user_row.html" %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Controles de paginación -->
            <div class="mt-4 flex items-center justify-between border-t pt-4">
                <div class="text-sm text-gray-600">
                    Mostrando <span id="page-start">1</span> - <span id="page-end">10</span> de <span
                        id="total-users">{{ users|length }}</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="changePage('first')" id="btn-first"
                        class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Primera página">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button onclick="changePage('prev')" id="btn-prev"
                        class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Anterior
                    </button>
                    <span class="px-3 py-1 text-sm text-gray-700">
                        Página <span id="current-page">1</span> de <span id="total-pages">1</span>
                    </span>
                    <button onclick="changePage('next')" id="btn-next"
                        class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Siguiente
                    </button>
                    <button onclick="changePage('last')" id="btn-last"
                        class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Última página">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </section>
    </div>

    <div id="content-correos" class="tab-content hidden">

        <section class="bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500 mb-8">
            <h2 class="text-xl font-bold mb-4 text-indigo-600 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                Configuración General de Correos (Defaults)
            </h2>

            <form hx-post="/admin/defaults/update" hx-target="#defaults-response" class="space-y-4">
                <div id="defaults-response"></div>
                <p class="text-sm text-gray-500 mb-2">Estos correos recibirán copia de <strong>todas</strong> las
                    notificaciones del sistema. Para múltiples correos, sepáralos con punto y coma (<code>;</code>).</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Default TO (Destinatarios)</label>
                        <input type="text" name="default_to" value="{{ defaults.default_to }}"
                            placeholder="email1@enertika.mx; email2@..."
                            class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Default CC (Copias)</label>
                        <input type="text" name="default_cc" value="{{ defaults.default_cc }}"
                            placeholder="director@enertika.mx; gerente@..."
                            class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Default CCO (Ocultos)</label>
                        <input type="text" name="default_cco" value="{{ defaults.default_cco }}"
                            placeholder="auditoria@enertika.mx"
                            class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow transition-colors">
                        Guardar Defaults
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white p-6 rounded-lg shadow border-t-4 border-[#00BABB]">
            <h2 class="text-xl font-bold mb-4 text-[#123456]">Reglas de Correo Inteligentes</h2>

            <form hx-post="/admin/rules/add" hx-target="#rules-table-container"
                class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Módulo</label>
                        <select name="modulo" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-[#00BABB] focus:border-[#00BABB] sm:text-sm rounded-md">
                            <option value="" disabled selected>Selecciona módulo...</option>
                            <option value="GLOBAL">GLOBAL (Todos los módulos)</option>
                            <option value="SIMULACION">Simulación</option>
                            <option value="COMERCIAL">Comercial</option>
                            <option value="PROYECTOS">Proyectos</option>
                            <option value="COMPRAS">Compras</option>
                            <option value="LEVANTAMIENTOS">Levantamientos</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Campo Disparador</label>
                        <select name="trigger_field" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                            hx-get="/admin/partials/trigger-options" hx-target="#trigger-value-container"
                            hx-swap="innerHTML" hx-trigger="change">
                            <option value="" disabled selected>Selecciona un disparador...</option>
                            <option value="Tecnología">Tecnología</option>
                            <option value="Tipo Solicitud">Tipo Solicitud</option>
                            <option value="Estatus">Estatus</option>
                            <option value="Cliente">Cliente (Texto libre)</option>
                            <option value="EVENTO">Evento de Sistema</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Requerido</label>
                        <div id="trigger-value-container">
                            <input type="text" disabled placeholder="⬅ Selecciona un campo primero"
                                class="w-full rounded-lg border-gray-300 bg-gray-100 text-gray-400 cursor-not-allowed">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email a Agregar</label>
                        <input type="email" name="email_to_add" placeholder="usuario@enertika.mx" required
                            class="w-full rounded-lg border-gray-300 focus:ring-[#00BABB] focus:border-[#00BABB]">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
                        <select name="type"
                            class="w-full rounded-lg border-gray-300 focus:ring-[#00BABB] focus:border-[#00BABB]">
                            <option value="CC">CC (Copia)</option>
                            <option value="TO">TO (Destinatario)</option>
                            <option value="CCO">CCO (Oculto)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit"
                            class="w-full bg-[#00BABB] hover:bg-[#009999] text-white px-4 py-2.5 rounded-lg font-bold flex justify-center items-center gap-2">
                            <span>➕</span> Crear Regla
                        </button>
                    </div>
                </div>
            </form>

            <div id="rules-table-container" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Módulo</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Campo</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Valor</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Email Agregado
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Tipo</th>
                            <th class="px-6 py-3 text-right"></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for r in rules %}
                        <tr id="rule-{{ r.id }}" class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-bold text-gray-900">
                                <span
                                    class="px-2 py-1 rounded text-xs font-bold {{ 'bg-purple-100 text-purple-800' if r.modulo == 'GLOBAL' else 'bg-gray-100 text-gray-800' }}">
                                    {{ r.modulo }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">{{ r.trigger_field }}</td>
                            <td class="px-6 py-4 text-sm font-mono text-gray-600 bg-gray-50 rounded">{{ r.trigger_value
                                }}</td>
                            <td class="px-6 py-4 text-sm font-bold text-gray-900">{{ r.email_to_add }}</td>
                            <td class="px-6 py-4">
                                <span
                                    class="px-2 py-1 rounded text-xs font-bold {{ 'bg-blue-100 text-blue-800' if r.type == 'CC' else 'bg-green-100 text-green-800' }}">
                                    {{ r.type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button hx-delete="/admin/rules/{{ r.id }}" hx-target="#rule-{{ r.id }}"
                                    hx-swap="outerHTML swap:1s" hx-confirm="¿Eliminar esta regla de correo?"
                                    class="text-red-500 hover:text-red-700 font-bold p-2 transition-colors duration-200"
                                    title="Eliminar regla">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- TAB: Buzones Notificaciones -->
    {% include 'admin/partials/content_buzones.html' %}

    <div id="content-catalogos" class="tab-content hidden">
        {% include "admin/partials/catalogs_management.html" %}
    </div>

    <div id="content-config" class="tab-content hidden">
        {% include "admin/partials/global_config.html" %}
    </div>

</div>

<!-- Modal Container Global para Buzones -->
<div id="config-correos-modal"></div>
<div id="config-umbrales-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>

<style>
    .tab-content {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // --- SISTEMA DE PESTAÑAS ---
    function switchTab(tabName) {
        // Ocultar todos los contenidos
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

        // Desactivar botones
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-[#00BABB]', 'text-[#123456]');
            btn.classList.add('border-transparent', 'text-gray-500');
            // Reset icono color
            const icon = btn.querySelector('svg');
            if (icon) icon.classList.remove('text-[#00BABB]');
        });

        // Mostrar contenido
        const content = document.getElementById('content-' + tabName);
        if (content) content.classList.remove('hidden');

        // Activar botón
        const activeBtn = document.getElementById('tab-' + tabName);
        if (activeBtn) {
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-[#00BABB]', 'text-[#123456]');
            const icon = activeBtn.querySelector('svg');
            if (icon) icon.classList.add('text-[#00BABB]');
        }

        sessionStorage.setItem('activeAdminTab', tabName);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTab = sessionStorage.getItem('activeAdminTab') || 'usuarios';
        switchTab(savedTab);
    });

    // --- MODAL PERMISOS ---
    let allModules = {{ modules | tojson | safe }};
    let allDepartments = {{ departments | tojson | safe }};
    let currentUserId = null;
    let currentUserPref = "";

    function openPermissionsModal(userId, userName, userPref) {
        currentUserId = userId;
        currentUserPref = userPref || "";
        document.getElementById('modal-user-name').textContent = userName;
        document.getElementById('perms-response').innerHTML = '';
        loadUserPermissions(userId);
        document.getElementById('permissions-modal').classList.remove('hidden');
    }

    function closePermissionsModal() {
        document.getElementById('permissions-modal').classList.add('hidden');
        currentUserId = null;
    }

    async function loadUserPermissions(userId) {
        try {
            const userRow = document.getElementById(`user-${userId}`);
            const deptCell = userRow ? userRow.querySelector('td:nth-child(3)') : null;
            const currentDeptName = deptCell ? deptCell.textContent.trim() : '';

            const deptSelect = document.getElementById('user-department');
            const foundDept = allDepartments.find(d => d.nombre === currentDeptName);
            if (foundDept) deptSelect.value = foundDept.slug;

            const resp = await fetch(`/admin/users/${userId}/modules`);
            const permisos = await resp.json();

            const tbody = document.getElementById('modules-list');
            tbody.innerHTML = '';

            const prefSelect = document.getElementById('user-preferred-module');
            prefSelect.innerHTML = '<option value="">-- Auto --</option>';

            allModules.forEach(mod => {
                const p = permisos.find(x => x.modulo_slug === mod.slug);
                const rol = p ? p.rol_modulo : '';

                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-2 flex items-center gap-2">
                        <i class="${mod.icono || 'bi-box'} text-lg text-[#00BABB]"></i> ${mod.nombre}
                    </td>
                    <td class="p-2">
                        <select name="modulo_${mod.slug}" class="w-full rounded border-gray-300 text-sm">
                            <option value="">Sin Acceso</option>
                            <option value="viewer" ${rol === 'viewer' ? 'selected' : ''}>Viewer</option>
                            <option value="editor" ${rol === 'editor' ? 'selected' : ''}>Editor</option>
                            <option value="admin" ${rol === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);

                if (rol) {
                    const opt = document.createElement('option');
                    opt.value = mod.slug;
                    opt.textContent = mod.nombre;
                    prefSelect.appendChild(opt);
                }
            });

            // Restore saved preference
            if (currentUserPref) {
                prefSelect.value = currentUserPref;
            }

            // Cargar flag de simulación (reutiliza userRow de línea 431)
            if (userRow && userRow.dataset.simulationFlag) {
                document.getElementById('user-simulation-flag').checked = userRow.dataset.simulationFlag === 'true';
            } else {
                document.getElementById('user-simulation-flag').checked = false;
            }

        } catch (e) {
            console.error(e);
            document.getElementById('perms-response').innerHTML = '<div class="text-red-500">Error cargando datos</div>';
        }
    }

    async function savePermissions() {
        if (!currentUserId) return;

        // Mostrar overlay de carga
        const overlay = document.getElementById('perms-loading-overlay');
        overlay.classList.remove('hidden');

        const msgDiv = document.getElementById('perms-response');
        msgDiv.innerHTML = '';

        try {
            const deptSlug = document.getElementById('user-department').value;
            if (deptSlug) {
                const fd = new FormData();
                fd.append('department_slug', deptSlug);
                await fetch(`/admin/users/${currentUserId}/department`, { method: 'POST', body: fd });
            }

            const form = document.getElementById('permissions-form');
            await fetch(`/admin/users/${currentUserId}/modules`, { method: 'POST', body: new FormData(form) });

            const pref = document.getElementById('user-preferred-module').value;
            const fdPref = new FormData();
            fdPref.append('modulo_slug', pref);
            await fetch(`/admin/users/${currentUserId}/preferred-module`, { method: 'POST', body: fdPref });

            // Guardar flag de simulación
            const simFlag = document.getElementById('user-simulation-flag').checked;
            const fdSim = new FormData();
            fdSim.append('puede_asignarse_simulacion', simFlag ? 'true' : 'false');
            await fetch(`/admin/users/${currentUserId}/simulation-flag`, { method: 'POST', body: fdSim });

            // Mostrar éxito y recargar
            setTimeout(() => location.reload(), 500);

        } catch (e) {
            overlay.classList.add('hidden');
            msgDiv.innerHTML = '<div class="text-red-600 font-bold">❗ Error al guardar. Intenta de nuevo.</div>';
        }
    }

    // --- BÚSQUEDA Y PAGINACIÓN DE USUARIOS ---
    let currentPage = 1;
    const itemsPerPage = 10;
    let allUserRows = [];
    let filteredRows = [];

    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('users-tbody');
        if (tbody) {
            allUserRows = Array.from(tbody.querySelectorAll('tr'));
            filteredRows = [...allUserRows];
            updatePagination();
        }
    });

    function filterUsers() {
        const searchTerm = document.getElementById('user-search').value.toLowerCase();
        const tbody = document.getElementById('users-tbody');

        filteredRows = allUserRows.filter(row => {
            const text = row.textContent.toLowerCase();
            return text.includes(searchTerm);
        });

        // Actualizar contador de usuarios
        document.getElementById('user-count-display').textContent = filteredRows.length;

        // Resetear a página 1 después de filtrar
        currentPage = 1;
        updatePagination();
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        // Ocultar todas las filas
        allUserRows.forEach(row => row.style.display = 'none');

        // Mostrar solo las filas de la página actual
        filteredRows.slice(start, end).forEach(row => row.style.display = '');

        // Actualizar textos
        document.getElementById('current-page').textContent = totalPages > 0 ? currentPage : 0;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('page-start').textContent = filteredRows.length > 0 ? start + 1 : 0;
        document.getElementById('page-end').textContent = Math.min(end, filteredRows.length);
        document.getElementById('total-users').textContent = filteredRows.length;

        // Habilitar/deshabilitar botones
        document.getElementById('btn-first').disabled = currentPage === 1;
        document.getElementById('btn-prev').disabled = currentPage === 1;
        document.getElementById('btn-next').disabled = currentPage >= totalPages;
        document.getElementById('btn-last').disabled = currentPage >= totalPages;
    }

    function changePage(action) {
        const totalPages = Math.ceil(filteredRows.length / itemsPerPage);

        switch (action) {
            case 'first':
                currentPage = 1;
                break;
            case 'prev':
                if (currentPage > 1) currentPage--;
                break;
            case 'next':
                if (currentPage < totalPages) currentPage++;
                break;
            case 'last':
                currentPage = totalPages;
                break;
        }

        updatePagination();

        // Scroll suave a la tabla
        document.querySelector('#users-tbody').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
</script>

<div id="permissions-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
        <!-- Overlay de carga -->
        <div id="perms-loading-overlay"
            class="hidden absolute inset-0 bg-white bg-opacity-90 z-10 flex flex-col items-center justify-center rounded-lg">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#00BABB] mb-4"></div>
            <span class="text-[#123456] font-bold text-lg">Guardando cambios...</span>
            <span class="text-gray-500 text-sm mt-1">Por favor espera</span>
        </div>
        <div class="p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-[#123456]">Permisos: <span id="modal-user-name"
                        class="text-[#00BABB]"></span></h3>
                <button onclick="closePermissionsModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>

            <div id="perms-response" class="mb-4"></div>

            <form id="permissions-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700">Departamento</label>
                    <select id="user-department" class="w-full rounded-lg border-gray-300">
                        <option value="">-- Seleccionar --</option>
                        {% for d in departments %}
                        <option value="{{ d.slug }}">{{ d.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Módulos</label>
                    <table class="w-full text-sm border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Módulo</th>
                                <th class="p-2 text-left">Rol en Módulo</th>
                            </tr>
                        </thead>
                        <tbody id="modules-list"></tbody>
                    </table>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700">Módulo Inicio</label>
                    <select id="user-preferred-module" class="w-full rounded-lg border-gray-300"></select>
                </div>

                <!-- Flag Asignación Simulación -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="user-simulation-flag"
                            class="w-5 h-5 rounded text-[#00BABB] focus:ring-[#00BABB]">
                        <div>
                            <span class="text-sm font-bold text-gray-700">Puede asignarse a Simulación</span>
                            <span class="text-gray-500 text-xs block">Permitir ser responsable de simulaciones aunque no
                                esté en el departamento Simulación</span>
                        </div>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closePermissionsModal()"
                        class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancelar</button>
                    <button type="button" onclick="savePermissions()"
                        class="px-4 py-2 bg-[#00BABB] text-white rounded font-bold hover:bg-[#009999]">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}