{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in-up">

    <h1 class="text-3xl font-bold text-gray-800">Panel de Administraci칩n</h1>

    <!-- Gu칤a de Roles -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded shadow-sm">
        <h3 class="font-bold text-blue-700 mb-2">Gu칤a de Permisos y Roles:</h3>
        <ul class="text-sm text-blue-800 space-y-1">
            <li><strong>VIEWER:</strong> Solo puede consultar informaci칩n. No ve botones de "Guardar", "Editar" o
                "Eliminar".</li>
            <li><strong>USER (Editor):</strong> Puede crear y editar sus propios registros (flujo normal).</li>
            <li><strong>MANAGER:</strong> Puede editar y reasignar registros de su equipo.</li>
            <li><strong>ADMIN:</strong> Control total (incluyendo este panel de reglas).</li>
        </ul>
    </div>

    <!-- 1. GESTION DE USUARIOS -->
    <section class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4 text-blue-600 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                </path>
            </svg>
            Usuarios y Roles
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Nombre</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Departamento</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol
                            Sistema</th>
                        <th class="px-6 py-3 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for u in users %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{{ u.nombre }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">{{ u.email }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">{{ u.department or 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">
                            <!-- Role Selector Inline -->
                            <form hx-post="/admin/users/role" hx-swap="outerHTML">
                                <input type="hidden" name="user_id" value="{{ u.id_usuario }}">
                                <select name="role" onchange="htmx.trigger(this.form, 'submit')"
                                    class="text-sm border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                                    <option value="USER" {% if u.rol_sistema=='USER' %}selected{% endif %}>User</option>
                                    <option value="MANAGER" {% if u.rol_sistema=='MANAGER' %}selected{% endif %}>Manager
                                    </option>
                                    <option value="ADMIN" {% if u.rol_sistema=='ADMIN' %}selected{% endif %}>Admin
                                    </option>
                                </select>
                            </form>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-2">
                            <!-- Delete User -->
                            <button hx-delete="/admin/users/{{ u.id_usuario }}"
                                hx-confirm="쮼st치s seguro de eliminar este usuario? Tendr치 que loguearse de nuevo para volver a aparecer."
                                hx-target="closest tr" class="text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-2.002-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- 2. GESTION DE REGLAS DE CORREO -->
    <section class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4 text-purple-600 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                </path>
            </svg>
            Reglas de Correo Autom치tico
        </h2>

        <!-- Add Form -->
        <form hx-post="/admin/rules/add" hx-target="#rules-table-container"
            class="mb-6 bg-gray-50 p-4 rounded flex gap-4 items-end">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">M칩dulo</label>
                <select name="modulo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="COMERCIAL">COMERCIAL</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Trigger Field</label>
                <select name="trigger_field" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="tecnologia">Tecnolog칤a</option>
                    <option value="tipo_solicitud">Tipo Solicitud</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Valor Trigger</label>
                <input type="text" name="trigger_value" placeholder="e.g. BESS"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Email a Agregar</label>
                <input type="email" name="email_to_add" placeholder="experto@..."
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Tipo</label>
                <select name="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="CC">CC</option>
                    <option value="TO">TO</option>
                </select>
            </div>
            <button type="submit"
                class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 font-bold text-sm">
                + Agregar Regla
            </button>
        </form>

        <!-- Rules Table -->
        <div id="rules-table-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Si Campo...</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contiene...</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agregar Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Como</th>
                        <th class="px-6 py-3 text-right"></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for r in rules %}
                    <tr id="rule-{{ r.id }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ r.trigger_field }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ r.trigger_value }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">{{ r.email_to_add }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span
                                class="px-2 py-1 rounded-full text-xs font-bold {{ 'bg-blue-100 text-blue-800' if r.type == 'CC' else 'bg-green-100 text-green-800' }}">
                                {{ r.type }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button hx-delete="/admin/rules/{{ r.id }}" hx-target="#rule-{{ r.id }}" hx-swap="outerHTML"
                                class="text-red-600 hover:text-red-900 font-bold">游딈</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

</div>

<script>
    function updateTriggerValues() {
        const field = document.getElementById('triggerFieldSelect').value;
        const container = document.getElementById('triggerValueContainer');

        let html = '';

        if (field === 'tecnologia') {
            html = `
            <select name="trigger_value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                <option value="FV">FV</option>
                <option value="BESS">BESS</option>
                <option value="FV + BESS">FV + BESS</option>
                <option value="EOLICA">EOLICA</option>
                <option value="COGENERACION">COGENERACION</option>
            </select>
            `;
        } else if (field === 'tipo_solicitud') {
            html = `
            <select name="trigger_value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                <option value="PRE OFERTA">PRE OFERTA</option>
                <option value="LICITACION">LICITACION</option>
                <option value="DUE DILIGENCIA">DUE DILIGENCIA</option>
            </select>
            `;
        } else {
            html = `<input type="text" name="trigger_value" placeholder="Valor..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">`;
        }

        container.innerHTML = html;
    }

    // Init
    document.addEventListener('DOMContentLoaded', updateTriggerValues);
</script>
{% endblock %}