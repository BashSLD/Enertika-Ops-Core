{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in-up">

    <h1 class="text-3xl font-bold text-gray-800">Panel de Administraci칩n</h1>

    <!-- Gu칤a de Roles -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded shadow-sm">
        <h3 class="font-bold text-blue-700 mb-2">Gu칤a de Permisos y Roles:</h3>
        <ul class="text-sm text-blue-800 space-y-1">
            <li><strong>VIEWER:</strong> Solo puede consultar informaci칩n. No ve botones de "Guardar", "Editar" o
                "Eliminar".</li>
            <li><strong>USER (Editor):</strong> Puede crear y editar sus propios registros (flujo normal).</li>
            <li><strong>MANAGER:</strong> Puede editar y reasignar registros de su equipo.</li>
            <li><strong>ADMIN:</strong> Control total (incluyendo este panel de reglas).</li>
        </ul>
    </div>

    <!-- 1. GESTION DE USUARIOS -->
    <section class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4 text-blue-600 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                </path>
            </svg>
            Usuarios y Roles
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Nombre</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Departamento</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol
                            Sistema</th>
                        <th class="px-6 py-3 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for u in users %}
                    {% include "admin/partials/user_row.html" %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- 2. CONFIGURACI칍N GLOBAL DE CORREOS -->
    <section class="bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500">
        <h2 class="text-xl font-bold mb-4 text-indigo-600 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                </path>
            </svg>
            Configuraci칩n General de Correos (Defaults)
        </h2>
        <p class="text-sm text-gray-500 mb-4">Estos correos se incluir치n autom치ticamente en todos los env칤os. Usa
            <strong>Enter</strong> o <strong>;</strong> para agregar m칰ltiples.
        </p>

        <form hx-post="/admin/defaults/update" hx-target="#defaults-response" class="space-y-4">

            <div id="defaults-response"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- DEFAULT TO -->
                <div class="chip-wrapper">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Default TO</label>
                    <div
                        class="border border-gray-300 rounded-md p-2 focus-within:ring-1 focus-within:ring-indigo-500 bg-white">
                        <div class="chips-container flex flex-wrap gap-1">
                            {% if defaults.default_to %}
                            {% for email in defaults.default_to.split(';') %}
                            {% if email %}
                            <div
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 border border-indigo-200 mr-2 mb-1">
                                <span>{{ email }}</span>
                                <button type="button"
                                    class="chip-remove ml-1.5 inline-flex items-center justify-center text-indigo-400 hover:text-indigo-600 focus:outline-none">
                                    <svg class="h-4 w-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </div>
                        <input type="text" class="chip-input border-none focus:ring-0 p-1 text-sm w-full"
                            placeholder="Agregar correo...">
                    </div>
                    <input type="hidden" name="default_to" value="{{ defaults.default_to }}" class="recipients-hidden">
                </div>

                <!-- DEFAULT CC -->
                <div class="chip-wrapper">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Default CC</label>
                    <div
                        class="border border-gray-300 rounded-md p-2 focus-within:ring-1 focus-within:ring-indigo-500 bg-white">
                        <div class="chips-container flex flex-wrap gap-1">
                            {% if defaults.default_cc %}
                            {% for email in defaults.default_cc.split(';') %}
                            {% if email %}
                            <div
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200 mr-2 mb-1">
                                <span>{{ email }}</span>
                                <button type="button"
                                    class="chip-remove ml-1.5 inline-flex items-center justify-center text-blue-400 hover:text-blue-600 focus:outline-none">
                                    <svg class="h-4 w-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </div>
                        <input type="text" class="chip-input border-none focus:ring-0 p-1 text-sm w-full"
                            placeholder="Agregar correo...">
                    </div>
                    <input type="hidden" name="default_cc" value="{{ defaults.default_cc }}" class="recipients-hidden">
                </div>

                <!-- DEFAULT CCO -->
                <div class="chip-wrapper">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Default CCO (Oculto)</label>
                    <div
                        class="border border-gray-300 rounded-md p-2 focus-within:ring-1 focus-within:ring-indigo-500 bg-white">
                        <div class="chips-container flex flex-wrap gap-1">
                            {% if defaults.default_cco %}
                            {% for email in defaults.default_cco.split(';') %}
                            {% if email %}
                            <div
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800 border border-gray-200 mr-2 mb-1">
                                <span>{{ email }}</span>
                                <button type="button"
                                    class="chip-remove ml-1.5 inline-flex items-center justify-center text-gray-400 hover:text-gray-600 focus:outline-none">
                                    <svg class="h-4 w-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </div>
                        <input type="text" class="chip-input border-none focus:ring-0 p-1 text-sm w-full"
                            placeholder="Agregar correo...">
                    </div>
                    <input type="hidden" name="default_cco" value="{{ defaults.default_cco }}"
                        class="recipients-hidden">
                </div>
            </div>

            <div class="flex justify-end pt-2">
                <button type="submit"
                    class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-bold shadow transition-colors">
                    Guardar Configuraci칩n General
                </button>
            </div>
        </form>
    </section>

    <!-- 3. GESTION DE REGLAS DE CORREO -->
    <section class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4 text-purple-600 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                </path>
            </svg>
            Reglas Espec칤ficas (Condicionales)
        </h2>

        <!-- Add Form -->
        <form hx-post="/admin/rules/add" hx-target="#rules-table-container"
            class="mb-6 bg-gray-50 p-4 rounded flex gap-4 items-end">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">M칩dulo</label>
                <select name="modulo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="COMERCIAL">COMERCIAL</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Trigger Field</label>
                <select name="trigger_field" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="tecnologia">Tecnolog칤a</option>
                    <option value="tipo_solicitud">Tipo Solicitud</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Valor Trigger</label>
                <input type="text" name="trigger_value" placeholder="e.g. BESS"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Email a Agregar</label>
                <input type="email" name="email_to_add" placeholder="experto@..."
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Tipo</label>
                <select name="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="CC">CC</option>
                    <option value="TO">TO</option>
                </select>
            </div>
            <button type="submit"
                class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 font-bold text-sm">
                + Agregar Regla
            </button>
        </form>

        <!-- Rules Table -->
        <div id="rules-table-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Si Campo...</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contiene...</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agregar Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Como</th>
                        <th class="px-6 py-3 text-right"></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for r in rules %}
                    <tr id="rule-{{ r.id }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ r.trigger_field }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ r.trigger_value }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">{{ r.email_to_add }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span
                                class="px-2 py-1 rounded-full text-xs font-bold {{ 'bg-blue-100 text-blue-800' if r.type == 'CC' else 'bg-green-100 text-green-800' }}">
                                {{ r.type }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button hx-delete="/admin/rules/{{ r.id }}" hx-target="#rule-{{ r.id }}" hx-swap="outerHTML"
                                class="text-red-600 hover:text-red-900 font-bold">游딈</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

</div>

<script>
    function updateTriggerValues() {
        const fieldSelect = document.getElementById('triggerFieldSelect');
        const container = document.getElementById('triggerValueContainer');

        // Validaci칩n: Solo ejecutar si los elementos existen en el DOM
        if (!fieldSelect || !container) return;

        const field = fieldSelect.value;

        let html = '';

        if (field === 'tecnologia') {
            html = `
            <select name="trigger_value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                <option value="FV">FV</option>
                <option value="BESS">BESS</option>
                <option value="FV + BESS">FV + BESS</option>
                <option value="EOLICA">EOLICA</option>
                <option value="COGENERACION">COGENERACION</option>
            </select>
            `;
        } else if (field === 'tipo_solicitud') {
            html = `
            <select name="trigger_value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                <option value="PRE OFERTA">PRE OFERTA</option>
                <option value="LICITACION">LICITACION</option>
                <option value="DUE DILIGENCIA">DUE DILIGENCIA</option>
            </select>
            `;
        } else {
            html = `<input type="text" name="trigger_value" placeholder="Valor..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">`;
        }

        container.innerHTML = html;
    }

    // Init
    document.addEventListener('DOMContentLoaded', updateTriggerValues);
</script>
{% endblock %}