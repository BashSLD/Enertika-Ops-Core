{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in-up">

    <div class="flex items-center gap-3 mb-8">
        <div class="p-3 bg-white rounded-lg shadow-sm border border-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#123456"
                class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
        </div>
        <div>
            <h1 class="text-3xl font-bold text-[#123456]">Panel de Administraci√≥n</h1>
            <p class="text-sm text-gray-500">Control central de usuarios, reglas y cat√°logos.</p>
        </div>
    </div>

    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">

                <button onclick="switchTab('usuarios')" id="tab-usuarios"
                    class="tab-button border-b-2 border-[#00BABB] py-4 px-1 text-sm font-medium text-[#123456] flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 text-[#00BABB]">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    Usuarios y Roles
                </button>

                <button onclick="switchTab('correos')" id="tab-correos"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                    </svg>
                    Configuraci√≥n de Correos
                </button>

                <button onclick="switchTab('catalogos')" id="tab-catalogos"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    Cat√°logos
                </button>

                <button onclick="switchTab('config')" id="tab-config"
                    class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 group-hover:text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.159.956c.03.183.137.344.293.438l.956.577c.156.095.345.117.518.062l.945-.301a1.001 1.001 0 011.229.626l.47 1.092a1.001 1.001 0 01-.223 1.209l-.718.69a1.001 1.001 0 000 1.414l.718.69a1.001 1.001 0 01.223 1.209l-.47 1.092a1.001 1.001 0 01-1.229.626l-.945-.301a1.001 1.001 0 00-.518.062l-.956.577a1.001 1.001 0 00-.293.438l-.159.956c-.09.542-.56.94-1.11.94h-1.093c-.55 0-1.02-.398-1.11-.94l-.159-.956c-.03-.183-.137-.344-.293-.438l-.956-.577a1.001 1.001 0 00-.518-.062l-.945.301a1.001 1.001 0 01-1.229-.626l-.47-1.092a1.001 1.001 0 01.223-1.209l.718-.69a1.001 1.001 0 000-1.414l-.718-.69a1.001 1.001 0 01-.223-1.209l.47-1.092a1.001 1.001 0 011.229-.626l.945.301c.173.055.362.033.518-.062l.956-.577c.156-.095.263-.255.293-.438l.159-.956zM12 15a3 3 0 100-6 3 3 0 000 6z" />
                    </svg>
                    Configuraci√≥n
                </button>
            </nav>
        </div>
    </div>

    <div id="content-usuarios" class="tab-content">
        <div class="bg-[#E0F7F7] border-l-4 border-[#00BABB] p-4 rounded shadow-sm mb-6">
            <h3 class="font-bold text-[#123456] mb-2">Gu√≠a de Permisos y Roles:</h3>
            <ul class="text-sm text-[#123456] space-y-1">
                <li><strong>VIEWER:</strong> Solo puede consultar informaci√≥n.</li>
                <li><strong>USER (Editor):</strong> Puede crear y editar sus propios registros.</li>
                <li><strong>MANAGER:</strong> Puede editar y reasignar registros de su equipo.</li>
                <li><strong>ADMIN:</strong> Control total.</li>
            </ul>
        </div>

        <section class="bg-white p-6 rounded-lg shadow border-t-4 border-[#00BABB]">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√≥dulos</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Inicio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for u in users %}
                        {% include "admin/partials/user_row.html" %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="content-correos" class="tab-content hidden">

        <section class="bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500 mb-8">
            <h2 class="text-xl font-bold mb-4 text-indigo-600 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                Configuraci√≥n General de Correos (Defaults)
            </h2>

            <form hx-post="/admin/defaults/update" hx-target="#defaults-response" class="space-y-4">
                <div id="defaults-response"></div>
                <p class="text-sm text-gray-500 mb-2">Estos correos recibir√°n copia de <strong>todas</strong> las
                    notificaciones del sistema. Para m√∫ltiples correos, sep√°ralos con punto y coma (<code>;</code>).</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Default TO (Destinatarios)</label>
                        <input type="text" name="default_to" value="{{ defaults.default_to }}"
                            placeholder="email1@enertika.mx; email2@..."
                            class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Default CC (Copias)</label>
                        <input type="text" name="default_cc" value="{{ defaults.default_cc }}"
                            placeholder="director@enertika.mx; gerente@..."
                            class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Default CCO (Ocultos)</label>
                        <input type="text" name="default_cco" value="{{ defaults.default_cco }}"
                            placeholder="auditoria@enertika.mx"
                            class="w-full rounded-lg border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow transition-colors">
                        Guardar Defaults
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white p-6 rounded-lg shadow border-t-4 border-[#00BABB]">
            <h2 class="text-xl font-bold mb-4 text-[#123456]">Reglas de Correo Inteligentes</h2>

            <form hx-post="/admin/rules/add" hx-target="#rules-table-container"
                class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <input type="hidden" name="modulo" value="COMERCIAL">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Campo Disparador</label>
                        <select name="trigger_field" hx-get="/admin/partials/trigger-options"
                            hx-target="#trigger-value-container" hx-swap="innerHTML"
                            class="w-full rounded-lg border-gray-300 focus:ring-[#00BABB] focus:border-[#00BABB]">
                            <option value="" disabled selected>-- Selecciona --</option>
                            <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                            <option value="Tipo Solicitud">Tipo Solicitud</option>
                            <option value="Estatus">Estatus Global</option>
                            <option value="Cliente">Cliente (Texto Libre)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Requerido</label>
                        <div id="trigger-value-container">
                            <input type="text" disabled placeholder="‚¨Ö Selecciona un campo primero"
                                class="w-full rounded-lg border-gray-300 bg-gray-100 text-gray-400 cursor-not-allowed">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email a Agregar</label>
                        <input type="email" name="email_to_add" placeholder="usuario@enertika.mx" required
                            class="w-full rounded-lg border-gray-300 focus:ring-[#00BABB] focus:border-[#00BABB]">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
                        <select name="type"
                            class="w-full rounded-lg border-gray-300 focus:ring-[#00BABB] focus:border-[#00BABB]">
                            <option value="CC">CC (Copia)</option>
                            <option value="TO">TO (Destinatario)</option>
                            <option value="CCO">CCO (Oculto)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit"
                            class="w-full bg-[#00BABB] hover:bg-[#009999] text-white px-4 py-2.5 rounded-lg font-bold flex justify-center items-center gap-2">
                            <span>‚ûï</span> Crear Regla
                        </button>
                    </div>
                </div>
            </form>

            <div id="rules-table-container" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Campo</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Valor</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Email Agregado
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Tipo</th>
                            <th class="px-6 py-3 text-right"></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for r in rules %}
                        <tr id="rule-{{ r.id }}" class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm text-gray-900">{{ r.trigger_field }}</td>
                            <td class="px-6 py-4 text-sm font-mono text-gray-600 bg-gray-50 rounded">{{ r.trigger_value
                                }}</td>
                            <td class="px-6 py-4 text-sm font-bold text-gray-900">{{ r.email_to_add }}</td>
                            <td class="px-6 py-4">
                                <span
                                    class="px-2 py-1 rounded text-xs font-bold {{ 'bg-blue-100 text-blue-800' if r.type == 'CC' else 'bg-green-100 text-green-800' }}">
                                    {{ r.type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button hx-delete="/admin/rules/{{ r.id }}" hx-target="#rule-{{ r.id }}"
                                    hx-swap="outerHTML" class="text-red-500 hover:text-red-700 font-bold p-2">
                                    üóë
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="content-catalogos" class="tab-content hidden">
        {% include "admin/partials/catalogs_management.html" %}
    </div>

    <div id="content-config" class="tab-content hidden">
        {% include "admin/partials/global_config.html" %}
    </div>

</div>

<style>
    .tab-content {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // --- SISTEMA DE PESTA√ëAS ---
    function switchTab(tabName) {
        // Ocultar todos los contenidos
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

        // Desactivar botones
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-[#00BABB]', 'text-[#123456]');
            btn.classList.add('border-transparent', 'text-gray-500');
            // Reset icono color
            const icon = btn.querySelector('svg');
            if (icon) icon.classList.remove('text-[#00BABB]');
        });

        // Mostrar contenido
        const content = document.getElementById('content-' + tabName);
        if (content) content.classList.remove('hidden');

        // Activar bot√≥n
        const activeBtn = document.getElementById('tab-' + tabName);
        if (activeBtn) {
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-[#00BABB]', 'text-[#123456]');
            const icon = activeBtn.querySelector('svg');
            if (icon) icon.classList.add('text-[#00BABB]');
        }

        sessionStorage.setItem('activeAdminTab', tabName);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTab = sessionStorage.getItem('activeAdminTab') || 'usuarios';
        switchTab(savedTab);
    });

    // --- MODAL PERMISOS ---
    let allModules = {{ modules | tojson | safe }};
    let allDepartments = {{ departments | tojson | safe }};
    let currentUserId = null;

    function openPermissionsModal(userId, userName) {
        currentUserId = userId;
        document.getElementById('modal-user-name').textContent = userName;
        document.getElementById('perms-response').innerHTML = '';
        loadUserPermissions(userId);
        document.getElementById('permissions-modal').classList.remove('hidden');
    }

    function closePermissionsModal() {
        document.getElementById('permissions-modal').classList.add('hidden');
        currentUserId = null;
    }

    async function loadUserPermissions(userId) {
        try {
            const userRow = document.getElementById(`user-${userId}`);
            const deptCell = userRow ? userRow.querySelector('td:nth-child(3)') : null;
            const currentDeptName = deptCell ? deptCell.textContent.trim() : '';

            const deptSelect = document.getElementById('user-department');
            const foundDept = allDepartments.find(d => d.nombre === currentDeptName);
            if (foundDept) deptSelect.value = foundDept.slug;

            const resp = await fetch(`/admin/users/${userId}/modules`);
            const permisos = await resp.json();

            const tbody = document.getElementById('modules-list');
            tbody.innerHTML = '';

            const prefSelect = document.getElementById('user-preferred-module');
            prefSelect.innerHTML = '<option value="">-- Auto --</option>';

            allModules.forEach(mod => {
                const p = permisos.find(x => x.modulo_slug === mod.slug);
                const rol = p ? p.rol_modulo : '';

                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-2 flex items-center gap-2">
                        <span class="text-lg">${mod.icono || 'üì¶'}</span> ${mod.nombre}
                    </td>
                    <td class="p-2">
                        <select name="modulo_${mod.slug}" class="w-full rounded border-gray-300 text-sm">
                            <option value="">Sin Acceso</option>
                            <option value="viewer" ${rol === 'viewer' ? 'selected' : ''}>Viewer</option>
                            <option value="editor" ${rol === 'editor' ? 'selected' : ''}>Editor</option>
                            <option value="assignor" ${rol === 'assignor' ? 'selected' : ''}>Assignor</option>
                            <option value="admin" ${rol === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);

                if (rol) {
                    const opt = document.createElement('option');
                    opt.value = mod.slug;
                    opt.textContent = mod.nombre;
                    prefSelect.appendChild(opt);
                }
            });

        } catch (e) {
            console.error(e);
            document.getElementById('perms-response').innerHTML = '<div class="text-red-500">Error cargando datos</div>';
        }
    }

    async function savePermissions() {
        if (!currentUserId) return;
        const msgDiv = document.getElementById('perms-response');
        msgDiv.innerHTML = '<div class="text-blue-500">Guardando...</div>';

        try {
            const deptSlug = document.getElementById('user-department').value;
            if (deptSlug) {
                const fd = new FormData();
                fd.append('department_slug', deptSlug);
                await fetch(`/admin/users/${currentUserId}/department`, { method: 'POST', body: fd });
            }

            const form = document.getElementById('permissions-form');
            await fetch(`/admin/users/${currentUserId}/modules`, { method: 'POST', body: new FormData(form) });

            const pref = document.getElementById('user-preferred-module').value;
            const fdPref = new FormData();
            fdPref.append('modulo_slug', pref);
            await fetch(`/admin/users/${currentUserId}/preferred-module`, { method: 'POST', body: fdPref });

            msgDiv.innerHTML = '<div class="text-green-600 font-bold">‚úÖ Guardado. Recargando...</div>';
            setTimeout(() => location.reload(), 1000);

        } catch (e) {
            msgDiv.innerHTML = '<div class="text-red-600 font-bold">‚ùå Error al guardar</div>';
        }
    }
</script>

<div id="permissions-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-[#123456]">Permisos: <span id="modal-user-name"
                        class="text-[#00BABB]"></span></h3>
                <button onclick="closePermissionsModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>

            <div id="perms-response" class="mb-4"></div>

            <form id="permissions-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700">Departamento</label>
                    <select id="user-department" class="w-full rounded-lg border-gray-300">
                        <option value="">-- Seleccionar --</option>
                        {% for d in departments %}
                        <option value="{{ d.slug }}">{{ d.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">M√≥dulos</label>
                    <table class="w-full text-sm border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">M√≥dulo</th>
                                <th class="p-2 text-left">Rol</th>
                            </tr>
                        </thead>
                        <tbody id="modules-list"></tbody>
                    </table>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700">M√≥dulo Inicio</label>
                    <select id="user-preferred-module" class="w-full rounded-lg border-gray-300"></select>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closePermissionsModal()"
                        class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancelar</button>
                    <button type="button" onclick="savePermissions()"
                        class="px-4 py-2 bg-[#00BABB] text-white rounded font-bold hover:bg-[#009999]">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}