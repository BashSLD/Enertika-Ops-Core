<tr id="user-{{ u.id_usuario }}" class="{% if u.is_active is false %}bg-gray-100 text-gray-500{% endif %}"
    data-simulation-flag="{{ u.puede_asignarse_simulacion|default(false)|lower }}">
    <td
        class="px-6 py-4 whitespace-nowrap font-medium {% if u.is_active is false %}text-gray-500{% else %}text-gray-900{% endif %}">
        {{ u.nombre }}
        {% if u.is_active is false %}
        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-800">
            Inactivo
        </span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap">{{ u.email }}</td>

    <!-- Departamento con selector -->
    <td class="px-6 py-4 whitespace-nowrap">
        <span class="text-sm">{{ u.department or 'N/A' }}</span>
    </td>

    <!-- Módulos Asignados (badges) -->
    <td class="px-6 py-4">
        <div class="flex gap-1 flex-wrap max-w-xs">
            {% if u.user_modules %}
            {% for mod in u.user_modules %}
            <span
                class="px-2 py-1 text-xs rounded-lg bg-[#E0F7F7] text-[#123456] border border-[#00BABB] shadow-sm font-bold">
                {{ mod.modulo_nombre }}
                <span class="text-gray-600">({{ mod.rol_modulo }})</span>
            </span>
            {% endfor %}
            {% else %}
            <span class="text-gray-400 text-xs">Sin módulos</span>
            {% endif %}
        </div>
    </td>

    <!-- Módulo Preferido -->
    <td class="px-6 py-4 whitespace-nowrap">
        <span class="font-bold text-sm">{{ u.modulo_preferido_nombre or 'N/A' }}</span>
    </td>

    <!-- Rol Sistema -->
    <td class="px-6 py-4 whitespace-nowrap">
        {% if u.is_active is not false %}
        <form hx-post="/admin/users/role" hx-swap="outerHTML">
            <input type="hidden" name="user_id" value="{{ u.id_usuario }}">
            <select name="role" onchange="htmx.trigger(this.form, 'submit')"
                class="text-sm border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                <option value="USER" {% if u.rol_sistema=='USER' %}selected{% endif %}>User</option>
                <option value="MANAGER" {% if u.rol_sistema=='MANAGER' %}selected{% endif %}>Manager</option>
                <option value="ADMIN" {% if u.rol_sistema=='ADMIN' %}selected{% endif %}>Admin</option>
            </select>
        </form>
        {% else %}
        <span>{{ u.rol_sistema }}</span>
        {% endif %}
    </td>

    <!-- Acciones -->
    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
        <div class="flex justify-end gap-2">
            {% if u.is_active is not false %}
            <!-- Editar Permisos -->
            <button
                onclick="openPermissionsModal('{{ u.id_usuario }}', '{{ u.nombre }}', '{{ u.modulo_preferido or "" }}')"
                class="text-[#00BABB] hover:text-[#009999] font-bold transition-colors duration-200"
                title="Editar Permisos">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>

            <!-- Delete User -->
            <button hx-delete="/admin/users/{{ u.id_usuario }}" hx-confirm="¿Estás seguro de desactivar este usuario?"
                hx-target="#user-{{ u.id_usuario }}" hx-swap="outerHTML" class="text-red-500 hover:text-red-700"
                title="Desactivar Usuario">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-2.002-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
            </button>
            {% else %}
            <!-- Restore User -->
            <button hx-post="/admin/users/{{ u.id_usuario }}/restore" hx-target="#user-{{ u.id_usuario }}"
                hx-swap="outerHTML" class="text-green-500 hover:text-green-700" title="Reactivar Usuario">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
            {% endif %}
        </div>
    </td>
</tr>