<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Enertika Ops Core{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/ext/json-enc.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-900">

    <div class="flex h-screen overflow-hidden">
        {% if user_name %}
        <aside class="w-64 bg-[#123456] text-white flex flex-col shadow-2xl z-10 hidden md:flex">
            <div class="p-6 text-center border-b border-blue-900 bg-[#0E2A47]">
                <h1 class="text-xl font-bold tracking-wider text-[#00BABB]">Enertika Ops Core</h1>
                <div
                    class="mt-3 inline-block px-3 py-1 bg-blue-900/50 rounded-full text-xs font-mono text-blue-200 border border-blue-800">
                    {{ user_name }}
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto text-sm">
                <a href="#" hx-get="/comercial/ui" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-800/50 transition duration-150 group">
                    <span class="text-lg group-hover:scale-110 transition">üíº</span>
                    <span class="font-medium">Comercial</span>
                </a>
                <a href="#" hx-get="/simulacion/ui" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-800/50 transition duration-150 group">
                    <span class="text-lg group-hover:scale-110 transition">‚ö°</span>
                    <span class="font-medium">Simulaci√≥n</span>
                </a>
                <a href="#" hx-get="/levantamientos/ui" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-800/50 transition duration-150 group">
                    <span class="text-lg group-hover:scale-110 transition">üìã</span>
                    <span class="font-medium">Levantamientos</span>
                </a>

                <div class="my-4 border-t border-blue-900/30"></div>
                <p class="px-4 text-xs text-blue-400 font-semibold mb-2 uppercase tracking-wider">Futuros M√≥dulos</p>

                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 rounded-lg text-blue-300/50 cursor-not-allowed hover:bg-blue-900/20">
                    <span>üèóÔ∏è</span> Ingenier√≠a
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 rounded-lg text-blue-300/50 cursor-not-allowed hover:bg-blue-900/20">
                    <span>üöß</span> Construcci√≥n
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 rounded-lg text-blue-300/50 cursor-not-allowed hover:bg-blue-900/20">
                    <span>üîß</span> OyM
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-4 py-2 rounded-lg text-blue-300/50 cursor-not-allowed hover:bg-blue-900/20">
                    <span>üõí</span> Compras
                </a>

                {% if role == 'ADMIN' %}
                <div class="my-4 border-t border-blue-900/30"></div>
                <a href="/admin/ui"
                    class="flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-900/20 hover:bg-blue-800/50 text-yellow-100 border border-transparent hover:border-yellow-500/30 transition duration-150">
                    <span>‚öôÔ∏è</span> <span class="font-medium">Admin</span>
                </a>
                {% endif %}
            </nav>

            <div class="p-4 bg-[#0E2A47] border-t border-blue-900">
                <a href="/auth/logout"
                    class="flex items-center justify-center gap-2 w-full px-4 py-2 rounded-lg bg-red-900/20 text-red-200 hover:bg-red-900/40 transition duration-150 text-sm">
                    <span>üö™</span> Cerrar Sesi√≥n
                </a>
            </div>
        </aside>
        {% endif %}

        <main id="main-content" class="flex-1 overflow-y-auto relative bg-gray-50 w-full p-4 md:p-6 lg:p-8">
            {% block content %}
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center">
                <h2 class="text-2xl font-light text-gray-400">Selecciona un m√≥dulo del men√∫</h2>
            </div>
            {% endblock %}
        </main>
    </div>

    <div id="session-modal"
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] hidden flex items-center justify-center transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-orange-500 transform scale-100 animate-fade-in-down">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 mb-6">
                <svg class="h-8 w-8 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Sesi√≥n Expirada</h3>
            <p class="text-gray-600 mb-8">Tu conexi√≥n segura ha terminado. <br><strong>No recargues la p√°gina</strong>
                para no perder tu avance.</p>

            <div class="space-y-3">
                <button onclick="reconnectAndWatch()" id="reconnect-btn"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition">
                    üîÑ Re-conectar
                </button>
                <button onclick="document.getElementById('session-modal').classList.add('hidden')"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition">
                    Ya inici√© sesi√≥n, continuar!!!
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- FUNCI√ìN DE RECONEXI√ìN INTELIGENTE ---
        function reconnectAndWatch() {
            const btn = document.getElementById('reconnect-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">Esperando login...</span>';
            btn.disabled = true;

            // 1. Abrir Popup
            const popup = window.open('/auth/login', 'LoginPopup', 'width=500,height=600,left=200,top=200');

            // 2. Iniciar vigilancia (Polling)
            // Preguntamos al servidor cada 1 segundo: "¬øYa revivi√≥ la sesi√≥n?"
            const timer = setInterval(() => {
                fetch('/comercial/form', { method: 'GET' })
                    .then(res => {
                        // Si recibimos OK (200) y NO es una redirecci√≥n al login...
                        if (res.ok && !res.redirected) {
                            // ¬°√âXITO!
                            clearInterval(timer); // Dejar de vigilar

                            if (popup) popup.close(); // Cerrar la ventana hija autom√°ticamente
                            console.log("Sesi√≥n validada. Recargando contenido...");

                            // FIX: Usar HTMX para recargar solo el contenido, no toda la p√°gina
                            htmx.ajax('GET', window.location.pathname, { target: '#main-content', swap: 'innerHTML' });

                            // Cerrar el modal
                            document.getElementById('session-modal').classList.add('hidden');
                        }
                    })
                    .catch(() => { /* Ignorar errores de red mientras esperamos */ });

                // Seguridad: Si el usuario cierra el popup manualmente, dejar de buscar a los 2 minutos
                if (popup && popup.closed) {
                    // Opcional: Podr√≠amos detener el timer, pero mejor seguir intentando un poco m√°s
                }
            }, 1000); // Checar cada 1 segundo
        }

        // --- INTERCEPTOR DE ERRORES 401 (Tu guardi√°n de datos) ---
        document.body.addEventListener('htmx:responseError', function (evt) {
            if (evt.detail.xhr.status === 401) {
                evt.preventDefault();
                evt.stopPropagation();
                document.getElementById('session-modal').classList.remove('hidden');
            }
        });

        // 1. SISTEMA DE ALERTA TEMPRANA (Heartbeat)
        setInterval(() => {
            fetch('/comercial/ui', { method: 'HEAD' }).then(res => {
                if (res.redirected || res.status === 401 || res.status === 403) {
                    document.getElementById('session-modal').classList.remove('hidden');
                }
            }).catch(() => { });
        }, 60000);

        // 2. CAJA FUERTE LOCAL (Auto-Save)
        document.addEventListener('input', (e) => {
            if (e.target.name && !e.target.type.match(/password|hidden|file/)) {
                localStorage.setItem('draft_' + window.location.pathname + '_' + e.target.name, e.target.value);
            }
        });

        // 3. RESTAURACI√ìN AUTOM√ÅTICA
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.name) {
                    const val = localStorage.getItem('draft_' + window.location.pathname + '_' + input.name);
                    if (val && !input.value) {
                        input.value = val;
                        input.style.borderColor = "#FBBF24";
                    }
                }
            });
        });

        // 4. LIMPIEZA POST-ENV√çO
        document.body.addEventListener('htmx:afterOnLoad', (evt) => {
            if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
                if (evt.detail.requestConfig.verb !== 'get') {
                    Object.keys(localStorage).forEach(k => {
                        if (k.startsWith('draft_' + window.location.pathname)) localStorage.removeItem(k);
                    });
                }
            }
        });

        // Scripts de Chips (Correos)
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('chip-input') && ['Enter', 'Tab', ';', ','].includes(e.key)) {
                e.preventDefault();
                addChip(e.target);
            }
        });
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('chip-remove')) removeChip(e.target);
        });
        function addChip(input) {
            const container = input.closest('.chip-wrapper');
            const hiddenInput = container.querySelector('.recipients-hidden');
            const chipsContainer = container.querySelector('.chips-container');
            let value = input.value.trim().replace(/[;,]/g, '');
            if (!value) return;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) { alert("Correo inv√°lido"); return; }
            const chip = document.createElement('div');
            chip.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200 mr-2 mb-2 animate-fade-in-down';
            chip.innerHTML = `<span>${value}</span><button type="button" class="chip-remove ml-2 text-blue-500 hover:text-blue-700 font-bold">√ó</button>`;
            chipsContainer.appendChild(chip);
            updateHiddenInput(hiddenInput, chipsContainer);
            input.value = '';
        }
        function removeChip(button) {
            const chip = button.closest('div');
            const container = button.closest('.chip-wrapper');
            chip.remove();
            updateHiddenInput(container.querySelector('.recipients-hidden'), container.querySelector('.chips-container'));
        }
        function updateHiddenInput(hidden, container) {
            hidden.value = Array.from(container.querySelectorAll('span')).map(s => s.textContent).join(';');
        }
    </script>
</body>

</html>