<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Enertika Ops Core{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/ext/json-enc.js"></script>

    <!-- Inicializar Alpine store ANTES de cargar Alpine.js -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('notifications', { count: 0 });
        });
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Variables de Colores Corporativos Enertika */
        :root {
            --enertika-primary: #123456;
            --enertika-secondary: #00BABB;
            --enertika-secondary-dark: #009999;
            --enertika-dark: #0E2A47;
            --enertika-secondary-light: #E0F7F7;
        }

        /* === ANIMACIONES === */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.5;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* === CLASES DE ANIMACI√ìN === */
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        .animate-pulse-subtle {
            animation: pulse-subtle 2s ease-in-out infinite;
        }

        .animate-slide-in {
            animation: slideInRight 0.3s ease-out;
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg,
                    #f0f0f0 0%,
                    #e0e0e0 50%,
                    #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }

        .skeleton-title {
            height: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* Ripple Effect */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple-effect:active::after {
            width: 300px;
            height: 300px;
        }

        /* Smooth transitions globales */
        * {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Utility classes para colores corporativos */
        .bg-enertika-primary {
            background-color: var(--enertika-primary);
        }

        .bg-enertika-secondary {
            background-color: var(--enertika-secondary);
        }

        .text-enertika-primary {
            color: var(--enertika-primary);
        }

        .text-enertika-secondary {
            color: var(--enertika-secondary);
        }

        .border-enertika-secondary {
            border-color: var(--enertika-secondary);
        }

        /* Loading spinner corporativo */
        .spinner-enertika {
            border: 3px solid #E0F7F7;
            border-top: 3px solid #00BABB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* HTMX Indicator - Oculto por defecto, visible durante peticiones */
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator {
            display: flex;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* Custom Scrollbar for Expanded Sidebar (Enertika Theme) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0E2A47;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #00BABB;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #009999;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-900">

    <div class="flex h-screen overflow-hidden"
        x-data="{ sidebarOpen: localStorage.getItem('sidebarOpen') !== 'false', mobileMenuOpen: false }"
        x-init="$watch('sidebarOpen', val => localStorage.setItem('sidebarOpen', val))">

        {% if user_name %}
        <!-- MOBILE HEADER -->
        <header
            class="fixed top-0 left-0 right-0 h-14 bg-[#123456] text-white flex items-center justify-between px-4 z-30 md:hidden shadow-lg">
            <button @click="mobileMenuOpen = true" class="p-2 rounded-lg hover:bg-blue-800/50 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <span class="text-lg font-bold text-[#00BABB]">Enertika</span>
            <div class="relative">
                <span class="text-lg">üîî</span>
                <span x-show="$store.notifications?.count > 0"
                    x-text="$store.notifications?.count > 99 ? '99+' : $store.notifications?.count"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1 rounded-full min-w-[14px] text-center"></span>
            </div>
        </header>

        <!-- MOBILE OVERLAY -->
        <div x-show="mobileMenuOpen" x-transition:enter="transition-opacity ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0" @click="mobileMenuOpen = false"
            class="fixed inset-0 bg-black/60 z-40 md:hidden" style="display: none;"></div>
        <aside
            class="bg-[#123456] text-white flex flex-col shadow-2xl z-50 transition-all duration-300 ease-in-out overflow-hidden fixed md:relative inset-y-0 left-0 transform md:transform-none"
            :class="[
                sidebarOpen ? 'w-64' : 'md:w-20 w-64',
                mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'
            ]">

            <!-- HEADING / LOGO -->
            <div class="p-4 border-b border-blue-900 bg-[#0E2A47] flex flex-col items-center justify-center transition-all duration-300"
                :class="sidebarOpen ? 'h-32' : 'h-20'">

                <!-- Expanded: Full Title -->
                <h1 x-show="sidebarOpen" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform scale-90"
                    x-transition:enter-end="opacity-100 transform scale-100"
                    class="text-xl font-bold tracking-wider text-[#00BABB] text-center whitespace-nowrap overflow-hidden">
                    Enertika Ops Core
                </h1>

                <!-- Collapsed: Mini Icon (E) -->
                <div x-show="!sidebarOpen" x-transition:enter="transition ease-out duration-200 delay-100"
                    x-transition:enter-start="opacity-0 transform rotate-180"
                    x-transition:enter-end="opacity-100 transform rotate-0" class="text-3xl font-black text-[#00BABB]">
                    E
                </div>

                <!-- USER INFO -->
                <div class="mt-3 flex items-center justify-center">
                    <!-- Expanded: Full Name Badge -->
                    <div x-show="sidebarOpen"
                        class="px-3 py-1 bg-blue-900/50 rounded-full text-xs font-mono text-blue-200 border border-blue-800 whitespace-nowrap overflow-hidden text-ellipsis max-w-[180px]">
                        {{ user_name }}
                    </div>

                    <!-- Collapsed: Initials Circle -->
                    <div x-show="!sidebarOpen"
                        class="w-8 h-8 flex items-center justify-center bg-blue-900/50 rounded-full text-xs font-mono text-blue-200 border border-blue-800"
                        title="{{ user_name }}">
                        {{ user_name[:2].upper() if user_name else 'OPS' }}
                    </div>
                </div>
            </div>

            <nav class="flex-1 space-y-1 overflow-y-auto overflow-x-hidden text-sm transition-all duration-300"
                :class="sidebarOpen ? 'p-4 custom-scrollbar' : 'p-2 no-scrollbar'">
                <!-- M√≥dulos Principales -->
                {% set all_modules = [
                {"slug": "comercial", "name": "Comercial", "icon": "üíº", "url": "/comercial/ui"},
                {"slug": "simulacion", "name": "Simulaci√≥n", "icon": "‚ö°", "url": "/simulacion/ui"},
                {"slug": "levantamientos", "name": "Levantamientos", "icon": "üìã", "url": "/levantamientos/ui"},
                {"slug": "proyectos", "name": "Proyectos", "icon": "üìÅ", "url": "/proyectos/ui"},
                {"slug": "construccion", "name": "Construcci√≥n", "icon": "üöß", "url": "/construccion/ui"},
                {"slug": "compras", "name": "Compras", "icon": "üõí", "url": "/compras/ui"},
                {"slug": "oym", "name": "O & M", "icon": "üîß", "url": "/oym/ui"}
                ] %}

                {% for module in all_modules %}
                {% set has_access = (role == 'ADMIN') or (module.slug in (module_roles or {})) %}

                <div class="relative group">
                    {% if has_access %}
                    <!-- M√ìDULO CON ACCESO -->
                    <a href="#" hx-get="{{ module.url }}" hx-target="#main-content" hx-swap="innerHTML"
                        hx-push-url="true" @click="mobileMenuOpen = false"
                        class="flex items-center gap-3 py-3 rounded-lg hover:bg-blue-800/50 transition duration-150 group/module overflow-hidden"
                        :class="sidebarOpen ? 'px-4 justify-start' : 'px-0 md:justify-center justify-start'">

                        <span class="text-lg transition-transform duration-200"
                            :class="sidebarOpen ? 'group-hover/module:scale-110' : ''">
                            {{ module.icon }}
                        </span>

                        <span class="font-medium whitespace-nowrap transition-opacity duration-200" x-show="sidebarOpen"
                            x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0"
                            x-transition:enter-end="opacity-100" class="md:hidden" :class="{'md:inline': sidebarOpen}">
                            {{ module.name }}
                        </span>
                        <span class="font-medium whitespace-nowrap md:hidden" x-show="!sidebarOpen">{{ module.name
                            }}</span>
                    </a>
                    {% else %}
                    <!-- M√ìDULO BLOQUEADO -->
                    <div class="flex items-center gap-3 py-3 rounded-lg opacity-40 overflow-hidden"
                        :class="sidebarOpen ? 'px-4 justify-start' : 'px-0 justify-center'">
                        <span class="text-lg">{{ module.icon }}</span>
                        <span class="font-medium text-gray-400 whitespace-nowrap" x-show="sidebarOpen">
                            {{ module.name }}
                        </span>
                        <span class="ml-auto text-xs" x-show="sidebarOpen">üîí</span>
                    </div>
                    {% endif %}

                    <!-- TOOLTIP (Only visible when sidebar is collapsed) -->
                    <div x-show="!sidebarOpen"
                        class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 bg-gray-900 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl border border-gray-700">
                        {{ module.name }}
                        {% if not has_access %} <span class="ml-1 text-xs text-gray-400">(Bloqueado)</span> {% endif %}
                        <!-- Arrow -->
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-gray-900">
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if role == 'ADMIN' %}
                <div class="my-4 border-t border-blue-900/30"></div>
                <div class="relative group">
                    <a href="/admin/ui"
                        class="flex items-center gap-3 py-3 rounded-lg bg-blue-900/20 hover:bg-blue-800/50 text-yellow-100 border border-transparent hover:border-yellow-500/30 transition duration-150 overflow-hidden"
                        :class="sidebarOpen ? 'px-4 justify-start' : 'px-0 justify-center'">
                        <span class="text-lg">‚öôÔ∏è</span>
                        <span class="font-medium whitespace-nowrap" x-show="sidebarOpen">Admin</span>
                    </a>
                    <!-- Tooltip for Admin -->
                    <div x-show="!sidebarOpen"
                        class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 bg-gray-900 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl border border-gray-700">
                        Admin
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-gray-900">
                        </div>
                    </div>
                </div>
                {% endif %}
            </nav>

            <!-- Notificaciones Bell Icon -->
            <div class="pb-2" x-data="{ open: false }">
                <button @click="open = !open"
                    class="relative w-full flex items-center gap-3 py-3 rounded-lg hover:bg-blue-800/50 transition"
                    :class="sidebarOpen ? 'px-4 justify-start' : 'px-0 justify-center'">
                    <span class="text-lg relative">
                        üîî
                        <!-- Badge for collapsed mode (over icon) -->
                        <span id="notification-badge-mini"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[16px] text-center border-2 border-[#123456]"
                            x-show="!sidebarOpen && $store.notifications?.count > 0"
                            x-text="$store.notifications?.count > 99 ? '99+' : $store.notifications?.count">
                            0
                        </span>
                    </span>
                    <span class="font-medium whitespace-nowrap" x-show="sidebarOpen">Notificaciones</span>

                    <!-- Badge for expanded mode (right side) -->
                    <span id="notification-badge"
                        class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full min-w-[20px] text-center"
                        x-show="sidebarOpen && $store.notifications?.count > 0"
                        x-text="$store.notifications?.count > 99 ? '99+' : $store.notifications?.count">
                        0
                    </span>
                </button>

                <!-- Dropdown -->
                <div x-show="open" @click.away="open = false" x-transition
                    class="absolute bottom-20 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 max-h-96 overflow-hidden z-50"
                    :class="sidebarOpen ? 'left-64' : 'left-20'" style="display: none;">

                    <div class="p-3 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50">
                        <h3 class="font-semibold text-gray-800">Notificaciones</h3>
                    </div>

                    <div id="notifications-dropdown" class="max-h-80 overflow-y-auto">
                        <!-- Notificaciones se agregan aqu√≠ din√°micamente -->
                        <div id="empty-notifications" class="p-8 text-center text-gray-400 text-sm">
                            <div class="text-4xl mb-2">üì≠</div>
                            <p>No hay notificaciones nuevas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AYUDA / DOCUMENTACI√ìN -->
            <div class="pb-2 border-t border-blue-900/30 mt-2">
                <div class="relative group">
                    <button @click="$dispatch('open-docs-modal')"
                        class="flex items-center gap-3 py-3 rounded-lg hover:bg-blue-800/50 transition duration-150 overflow-hidden w-full"
                        :class="sidebarOpen ? 'px-4 justify-start' : 'px-0 justify-center'"
                        title="Ayuda y Documentaci√≥n">

                        <span class="text-lg">‚ùì</span>
                        <span class="font-medium whitespace-nowrap" x-show="sidebarOpen">
                            Ayuda
                        </span>
                    </button>

                    <!-- Tooltip for collapsed mode -->
                    <div x-show="!sidebarOpen"
                        class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 bg-gray-900 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl border border-gray-700">
                        Ayuda y Documentaci√≥n
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-gray-900">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOGGLE BUTTON -->
            <div class="flex justify-center py-2 border-t border-blue-900 bg-[#0E2A47] cursor-pointer hover:bg-blue-800/50 transition-colors"
                @click="sidebarOpen = !sidebarOpen">
                <svg class="w-6 h-6 text-blue-300 transform transition-transform duration-300"
                    :class="sidebarOpen ? 'rotate-0' : 'rotate-180'" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                </svg>
            </div>

            <!-- LOGOUT -->
            <div class="p-2 bg-[#0E2A47] border-t border-blue-900">
                <div class="relative group">
                    <a href="/auth/logout"
                        class="flex items-center gap-2 w-full py-2 rounded-lg bg-red-900/20 text-red-200 hover:bg-red-900/40 transition duration-150 text-sm overflow-hidden"
                        :class="sidebarOpen ? 'px-4 justify-start' : 'px-0 justify-center h-10'">
                        <span class="text-lg">üö™</span>
                        <span class="whitespace-nowrap" x-show="sidebarOpen">Cerrar Sesi√≥n</span>
                    </a>

                    <!-- Tooltip for Logout -->
                    <div x-show="!sidebarOpen"
                        class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 bg-red-900 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl border border-red-800">
                        Cerrar Sesi√≥n
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-red-900">
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        {% endif %}

        <main id="main-content"
            class="flex-1 overflow-y-auto relative bg-gray-50 w-full p-4 md:p-6 lg:p-8 pt-18 md:pt-4">
            {% block content %}
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center">
                <h2 class="text-2xl font-light text-gray-400">Selecciona un m√≥dulo del men√∫</h2>
            </div>
            {% endblock %}
        </main>
    </div>

    <div id="session-modal"
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] hidden flex items-center justify-center transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-orange-500 transform scale-100 animate-fade-in-down">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 mb-6">
                <svg class="h-8 w-8 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Sesi√≥n Expirada</h3>
            <p class="text-gray-600 mb-8">Tu conexi√≥n segura ha terminado. <br><strong>No recargues la p√°gina</strong>
                para no perder tu avance.</p>

            <div class="space-y-3">
                <button onclick="reconnectAndWatch()" id="reconnect-btn"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition">
                    üîÑ Re-conectar
                </button>
                <button onclick="document.getElementById('session-modal').classList.add('hidden')"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition">
                    Ya inici√© sesi√≥n, continuar!!!
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- FUNCI√ìN DE RECONEXI√ìN INTELIGENTE ---
        function reconnectAndWatch() {
            const btn = document.getElementById('reconnect-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">Esperando login...</span>';
            btn.disabled = true;

            // 1. Abrir Popup
            const popup = window.open('/auth/login', 'LoginPopup', 'width=500,height=600,left=200,top=200');

            // 2. Iniciar vigilancia (Polling)
            // Preguntamos al servidor cada 1 segundo: "¬øYa revivi√≥ la sesi√≥n?"
            const timer = setInterval(() => {
                // FIX: Usar la ruta actual en lugar de hardcoded /comercial/form
                fetch(window.location.pathname, { method: 'HEAD' })
                    .then(res => {
                        // Si recibimos OK (200) y NO es una redirecci√≥n al login...
                        if (res.ok && !res.redirected) {
                            // ¬°√âXITO!
                            clearInterval(timer); // Dejar de vigilar

                            if (popup) popup.close(); // Cerrar la ventana hija autom√°ticamente
                            console.log("Sesi√≥n validada. Recargando contenido...");

                            // FIX: Usar HTMX para recargar solo el contenido, no toda la p√°gina
                            htmx.ajax('GET', window.location.pathname, { target: '#main-content', swap: 'innerHTML' });

                            // Cerrar el modal
                            document.getElementById('session-modal').classList.add('hidden');
                        }
                    })
                    .catch(() => { /* Ignorar errores de red mientras esperamos */ });

                // Seguridad: Si el usuario cierra el popup manualmente, dejar de buscar a los 2 minutos
                if (popup && popup.closed) {
                    // Opcional: Podr√≠amos detener el timer, pero mejor seguir intentando un poco m√°s
                }
            }, 1000); // Checar cada 1 segundo
        }

        // --- INTERCEPTOR DE ERRORES 401 (Tu guardi√°n de datos) ---
        document.body.addEventListener('htmx:responseError', function (evt) {
            if (evt.detail.xhr.status === 401) {
                evt.preventDefault();
                evt.stopPropagation();
                document.getElementById('session-modal').classList.remove('hidden');
            }
        });

        // 1. SISTEMA DE ALERTA TEMPRANA (Heartbeat)
        setInterval(() => {
            // FIX: Usar la ruta actual en lugar de hardcoded /comercial/ui
            fetch(window.location.pathname, { method: 'HEAD' }).then(res => {
                if (res.redirected || res.status === 401 || res.status === 403) {
                    document.getElementById('session-modal').classList.remove('hidden');
                }
            }).catch(() => { });
        }, 60000);

        // 2. CAJA FUERTE LOCAL (Auto-Save)
        document.addEventListener('input', (e) => {
            if (e.target.name && !e.target.type.match(/password|hidden|file/)) {
                localStorage.setItem('draft_' + window.location.pathname + '_' + e.target.name, e.target.value);
            }
        });

        // 3. RESTAURACI√ìN AUTOM√ÅTICA
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.name) {
                    const val = localStorage.getItem('draft_' + window.location.pathname + '_' + input.name);
                    if (val && !input.value) {
                        input.value = val;
                        input.style.borderColor = "#FBBF24";
                    }
                }
            });
        });

        // 4. LIMPIEZA POST-ENV√çO
        document.body.addEventListener('htmx:afterOnLoad', (evt) => {
            if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
                if (evt.detail.requestConfig.verb !== 'get') {
                    Object.keys(localStorage).forEach(k => {
                        if (k.startsWith('draft_' + window.location.pathname)) localStorage.removeItem(k);
                    });
                }
            }
        });

        // Scripts de Chips (Correos)
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('chip-input') && ['Enter', 'Tab', ';', ','].includes(e.key)) {
                e.preventDefault();
                addChip(e.target);
            }
        });
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('chip-remove')) removeChip(e.target);
        });
        function addChip(input) {
            const container = input.closest('.chip-wrapper');
            const hiddenInput = container.querySelector('.recipients-hidden');
            const chipsContainer = container.querySelector('.chips-container');
            let value = input.value.trim().replace(/[;,]/g, '');
            if (!value) return;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) { alert("Correo inv√°lido"); return; }
            const chip = document.createElement('div');
            chip.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200 mr-2 mb-2 animate-fade-in-down';
            chip.innerHTML = `<span>${value}</span><button type="button" class="chip-remove ml-2 text-blue-500 hover:text-blue-700 font-bold">√ó</button>`;
            chipsContainer.appendChild(chip);
            updateHiddenInput(hiddenInput, chipsContainer);
            input.value = '';
        }
        function removeChip(button) {
            const chip = button.closest('div');
            const container = button.closest('.chip-wrapper');
            chip.remove();
            updateHiddenInput(container.querySelector('.recipients-hidden'), container.querySelector('.chips-container'));
        }
        function updateHiddenInput(hidden, container) {
            hidden.value = Array.from(container.querySelectorAll('span')).map(s => s.textContent).join(';');
        }

        // === SISTEMA DE TOAST AUTOM√ÅTICO ===
        // Detecta par√°metros en la URL para mostrar mensajes de √©xito despu√©s de redirecciones
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);

            // Detectar creaci√≥n de oportunidad
            if (urlParams.has('new_op')) {
                const opId = urlParams.get('new_op');
                const esFuera = urlParams.get('fh') === 'true';

                // SOLO mostrar toast si es FUERA de horario
                if (esFuera) {
                    const toastHtml = `
                        <div class="bg-white border-l-4 border-orange-500 shadow-lg rounded p-4 mb-4 flex items-center gap-3 animate-fade-in-down w-80 pointer-events-auto">
                            <div class="p-2 rounded-full bg-orange-100 text-orange-600">
                                üåô
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">Oportunidad Creada</p>
                                <p class="text-sm text-gray-600">Ref: ${opId}</p>
                                <p class="text-xs text-orange-600 font-bold mt-1">‚ö†Ô∏è Registrado Fuera de Horario</p>
                            </div>
                            <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600 cursor-pointer">‚úï</button>
                        </div>
                    `;

                    const container = document.getElementById('global-toast-container');
                    if (container) {
                        container.innerHTML = toastHtml;

                        // Autocerrar a los 5 segundos
                        setTimeout(() => {
                            if (container.firstChild) container.firstChild.remove();
                        }, 5000);
                    }
                }

                // Limpiar URL para que no salga al recargar
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });


        // === SISTEMA DE NOTIFICACIONES EN TIEMPO REAL (SSE) ===
        let notificationSource = null;
        let unreadCount = 0;

        function initNotifications() {
            // OPTIMIZACI√ìN: Cargar contador con timeout para no bloquear UI
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Timeout')), 2000)
            );

            Promise.race([
                fetch('/notifications/count').then(r => r.json()),
                timeoutPromise
            ])
                .then(data => {
                    unreadCount = data.unread_count;
                    if (window.Alpine && window.Alpine.store('notifications')) {
                        window.Alpine.store('notifications').count = unreadCount;
                    }
                    updateBellIcon();
                })
                .catch(err => {
                    console.warn('[SSE] Contador no disponible (timeout o error):', err.message);
                    // Continuar sin bloquear - el contador se actualizar√° cuando lleguen notificaciones
                });

            // OPTIMIZACI√ìN: Conectar SSE de forma async despu√©s de cargar contador
            setTimeout(() => {
                try {
                    notificationSource = new EventSource('/notifications/stream');

                    // Evento 'pending': Notificaciones existentes al conectar
                    // NO incrementar contador (ya fueron contadas por /notifications/count)
                    notificationSource.addEventListener('pending', function (e) {
                        const notification = JSON.parse(e.data);
                        console.log('[SSE] Notificacion pendiente (existente):', notification);
                        // Solo agregar a dropdown, SIN incrementar contador ni mostrar toast
                        addNotificationToDropdown(notification);
                    });

                    // Evento 'notification': Notificaciones NUEVAS en tiempo real
                    // S√ç incrementar contador y mostrar toast
                    notificationSource.addEventListener('notification', function (e) {
                        const notification = JSON.parse(e.data);
                        console.log('[SSE] Nueva notificacion (tiempo real):', notification);

                        // Incrementar contador (solo para nuevas)
                        if (unreadCount < 99) {
                            unreadCount++;
                        }
                        updateBellIcon();

                        // Mostrar toast
                        showNotificationToast(notification);

                        // Agregar a dropdown
                        addNotificationToDropdown(notification);
                    });

                    notificationSource.onerror = function (e) {
                        console.error('[SSE] Error de conexion:', e);
                        // Reconectar despu√©s de 5s
                        if (notificationSource.readyState === EventSource.CLOSED) {
                            setTimeout(initNotifications, 5000);
                        }
                    };
                } catch (err) {
                    console.error('[SSE] Error iniciando EventSource:', err);
                }
            }, 100); // Delay m√≠nimo para no bloquear renderizado inicial
        }

        function updateBellIcon() {
            // Sincronizar con Alpine Store
            if (window.Alpine && window.Alpine.store('notifications')) {
                window.Alpine.store('notifications').count = unreadCount;
            }

            // Actualizar solo texto en el DOM
            const badgeMini = document.getElementById('notification-badge-mini');
            const badgeNormal = document.getElementById('notification-badge');
            const countText = unreadCount > 99 ? '99+' : unreadCount.toString();

            if (badgeMini) badgeMini.textContent = countText;
            if (badgeNormal) badgeNormal.textContent = countText;

            // Eliminamos la l√≥gica manual de style.display para no interferir con x-show de Alpine
            // y evitar duplicidad de badges.
        }

        function showNotificationToast(notif) {
            const toast = document.createElement('div');
            // Determine border color and icon based on notification type (if available)
            let borderColor = 'border-blue-500';
            let icon = 'üîî';
            if (notif.tipo === 'success') {
                borderColor = 'border-green-500';
                icon = '‚úÖ';
            } else if (notif.tipo === 'error') {
                borderColor = 'border-red-500';
                icon = '‚ùå';
            } else if (notif.tipo === 'warning') {
                borderColor = 'border-yellow-500';
                icon = '‚ö†Ô∏è';
            }

            toast.className = `fixed top-5 right-5 bg-white border-l-4 ${borderColor} shadow-2xl rounded-lg p-4 max-w-sm z-[9999] animate-fade-in-down`;
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 text-2xl">${icon}</div>
                    <div class="flex-1">
                        <p class="font-bold text-gray-800 text-sm">${escapeHtml(notif.title || notif.titulo)}</p>
                        <p class="text-sm text-gray-600 mt-1">${escapeHtml(notif.message || notif.mensaje)}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()"
                            class="text-gray-400 hover:text-gray-600 font-bold text-lg leading-none">
                        √ó
                    </button>
                </div>
            `;
            document.body.appendChild(toast);

            // Auto-cerrar despu√©s de 5s
            setTimeout(() => toast.remove(), 5000);
        }

        function addNotificationToDropdown(notif) {
            const dropdown = document.getElementById('notifications-dropdown');
            const emptyMsg = document.getElementById('empty-notifications');

            if (!dropdown) return;

            // Ocultar mensaje vac√≠o
            if (emptyMsg) {
                emptyMsg.style.display = 'none';
            }

            const item = document.createElement('div');
            item.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 transition-colors';
            item.dataset.notifId = notif.id;
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-800 truncate">${escapeHtml(notif.title)}</p>
                        <p class="text-xs text-gray-600 mt-1">${escapeHtml(notif.message)}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(notif.created_at)}</p>
                    </div>
                    <button onclick="event.stopPropagation(); deleteNotification('${notif.id}')" 
                            class="ml-2 text-gray-400 hover:text-red-500 text-lg font-bold" title="Eliminar">
                        √ó
                    </button>
                </div>
            `;
            item.onclick = async function () {
                // Esperar a que markAsRead complete antes de redirigir
                await markAsRead(notif.id);
                if (notif.oportunidad_id) {
                    // Redirigir al home, el sistema determinar√° el m√≥dulo correcto seg√∫n permisos
                    window.location.href = '/';
                }
            };
            dropdown.insertBefore(item, dropdown.firstChild);
        }

        function markAsRead(notifId) {
            // CR√çTICO: Retornar la Promise para que await funcione
            return fetch(`/notifications/mark-read/${notifId}`, { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    unreadCount = Math.max(0, unreadCount - 1);
                    if (window.Alpine && window.Alpine.store('notifications')) {
                        window.Alpine.store('notifications').count = unreadCount;
                    }
                    updateBellIcon();

                    // Actualizar visualmente el item
                    const item = document.querySelector(`[data-notif-id="${notifId}"]`);
                    if (item) {
                        item.style.opacity = '0.6';
                    }
                })
                .catch(err => {
                    console.error('[SSE] Error marcando como leida:', err);
                    throw err; // Re-throw para que el caller sepa que fallo
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Justo ahora';
            if (diffMins < 60) return `Hace ${diffMins} min`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `Hace ${diffHours}h`;

            return date.toLocaleDateString('es-MX', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function deleteNotification(notifId) {
            try {
                const response = await fetch(`/notifications/${notifId}`, { method: 'DELETE' });
                if (response.ok) {
                    // Remover visualmente
                    const item = document.querySelector(`[data-notif-id="${notifId}"]`);
                    if (item) {
                        item.style.transition = 'opacity 0.2s, transform 0.2s';
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(10px)';
                        setTimeout(() => item.remove(), 200);
                    }

                    // Actualizar contador
                    unreadCount = Math.max(0, unreadCount - 1);
                    updateBellIcon();
                    if (window.Alpine && window.Alpine.store('notifications')) {
                        window.Alpine.store('notifications').count = unreadCount;
                    }

                    // Mostrar mensaje vac√≠o si no hay m√°s notificaciones
                    setTimeout(() => {
                        const dropdown = document.getElementById('notifications-dropdown');
                        const emptyMsg = document.getElementById('empty-notifications');
                        if (dropdown && emptyMsg) {
                            const remainingItems = dropdown.querySelectorAll('[data-notif-id]');
                            if (remainingItems.length === 0) {
                                emptyMsg.style.display = 'block';
                            }
                        }
                    }, 250);
                }
            } catch (err) {
                console.error('[NOTIF] Error eliminando:', err);
            }
        }

        // OPTIMIZACI√ìN: Iniciar notificaciones DESPU√âS de que el DOM est√© listo
        // Usar requestIdleCallback para no bloquear renderizado cr√≠tico
        if (document.getElementById('notification-badge')) {
            if (window.requestIdleCallback) {
                // Navegadores modernos - esperar a que el navegador est√© idle
                window.requestIdleCallback(() => initNotifications(), { timeout: 1000 });
            } else {
                // Fallback - usar setTimeout con delay m√≠nimo
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => setTimeout(initNotifications, 200));
                } else {
                    setTimeout(initNotifications, 200);
                }
            }
        }

        // ========================================
        // REPORTES DASHBOARD (Alpine.js Component)
        // Definido aqu√≠ para que est√© disponible cuando HTMX carga partials
        // ========================================
        window.reportesDashboard = function () {
            return {
                activeTab: 'tecnologia',
                filtros: { fecha_inicio: '', fecha_fin: '', tecnologia: '', usuario: '' },
                charts: {},

                init() {
                    // Leer fechas del DOM si existen (inyectadas por Jinja)
                    const container = this.$el;
                    const startInput = container.querySelector('input[type="date"]');
                    if (startInput && startInput.value) {
                        this.filtros.fecha_inicio = startInput.value;
                    }

                    this.$nextTick(() => {
                        if (typeof Chart !== 'undefined') {
                            this.initCharts();
                            this.loadChartData();
                            this.loadTabContent('tecnologia');
                        }
                    });
                },

                formatDateRange() {
                    if (!this.filtros.fecha_inicio || !this.filtros.fecha_fin) return 'Cargando...';
                    try {
                        const inicio = new Date(this.filtros.fecha_inicio + 'T00:00:00');
                        const fin = new Date(this.filtros.fecha_fin + 'T00:00:00');
                        const opts = { day: '2-digit', month: 'short', year: 'numeric' };
                        return inicio.toLocaleDateString('es-MX', opts) + ' - ' + fin.toLocaleDateString('es-MX', opts);
                    } catch { return 'Error'; }
                },

                aplicarFiltros() {
                    this.loadChartData();
                    this.loadTabContent(this.activeTab);
                    this.loadKpis();
                },

                limpiarFiltros() {
                    const today = new Date();
                    this.filtros = {
                        fecha_inicio: new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0],
                        fecha_fin: today.toISOString().split('T')[0],
                        tecnologia: '', usuario: ''
                    };
                    this.aplicarFiltros();
                },

                getQueryParams() {
                    return new URLSearchParams({
                        start_date: this.filtros.fecha_inicio,
                        end_date: this.filtros.fecha_fin,
                        tech_id: this.filtros.tecnologia || '',
                        user_id: this.filtros.usuario || ''
                    }).toString();
                },

                async loadKpis() {
                    const c = document.getElementById('kpis-container');
                    if (c) {
                        try {
                            const r = await fetch('/simulacion/reportes/metricas?' + this.getQueryParams());
                            c.innerHTML = await r.text();
                        } catch (e) { console.error('Error KPIs:', e); }
                    }
                },

                async loadTabContent(tab) {
                    const endpoints = {
                        tecnologia: '/simulacion/reportes/por-tecnologia',
                        contabilizacion: '/simulacion/reportes/contabilizacion',
                        usuarios: '/simulacion/reportes/por-usuario',
                        mensual: '/simulacion/reportes/mensual'
                    };
                    const containers = { tecnologia: 'tech-container', contabilizacion: 'contab-container', usuarios: 'users-container', mensual: 'monthly-container' };
                    if (endpoints[tab]) {
                        const c = document.getElementById(containers[tab]);
                        if (c) {
                            c.innerHTML = '<div class="flex justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#00BABB]"></div></div>';
                            try {
                                const r = await fetch(endpoints[tab] + '?' + this.getQueryParams());
                                c.innerHTML = await r.text();
                            } catch { c.innerHTML = '<p class="text-red-500">Error</p>'; }
                        }
                    }
                },

                initCharts() {
                    // Los charts se crear√°n de forma lazy en updateCharts
                    // Esto evita problemas cuando los canvas no tienen dimensiones a√∫n
                    console.log('[Charts] Preparando sistema de gr√°ficas...');
                    this.chartsReady = true;
                },

                async loadChartData() {
                    try {
                        const r = await fetch('/simulacion/reportes/api/dashboard-data?' + this.getQueryParams());
                        const result = await r.json();
                        if (result.success) this.updateCharts(result.data);
                    } catch (e) { console.error('Error gr√°ficas:', e); }
                },

                // Renderiza charts que estaban pendientes porque su contenedor estaba oculto
                renderPendingCharts() {
                    if (!this._pendingCharts) return;

                    Object.entries(this._pendingCharts).forEach(([chartName, config]) => {
                        const canvas = document.getElementById(config.canvasId);
                        if (canvas && canvas.offsetParent !== null) {
                            // El canvas ahora es visible, renderizar
                            this.safeUpdateChart(chartName, config.canvasId, config.chartType, config.newData, config.chartOptions);
                            delete this._pendingCharts[chartName];
                        }
                    });
                },

                // Helper para crear o actualizar un chart de forma segura
                safeUpdateChart(chartName, canvasId, chartType, newData, chartOptions = {}, retryCount = 0) {
                    const MAX_RETRIES = 5;

                    try {
                        const canvas = document.getElementById(canvasId);
                        if (!canvas) {
                            // No reintentar si el canvas no existe en el DOM
                            return;
                        }

                        // Verificar que Chart.js est√© disponible
                        if (typeof Chart === 'undefined') {
                            console.warn('[Charts] Chart.js no disponible');
                            return;
                        }

                        // Verificar si el elemento est√° oculto (display:none o dentro de elemento oculto)
                        const isHidden = canvas.offsetParent === null;

                        // Verificar que el canvas tenga dimensiones
                        const rect = canvas.getBoundingClientRect();
                        if (rect.width === 0 || rect.height === 0) {
                            // Si est√° oculto, no reintentar (se crear√° cuando se muestre la pesta√±a)
                            if (isHidden) {
                                // Guardar los datos pendientes para cuando se muestre
                                this._pendingCharts = this._pendingCharts || {};
                                this._pendingCharts[chartName] = { canvasId, chartType, newData, chartOptions };
                                return;
                            }

                            // Si no est√° oculto pero no tiene dimensiones, reintentar con l√≠mite
                            if (retryCount < MAX_RETRIES) {
                                setTimeout(() => this.safeUpdateChart(chartName, canvasId, chartType, newData, chartOptions, retryCount + 1), 200);
                            }
                            return;
                        }

                        // Si el chart existe, actualizarlo
                        if (this.charts[chartName]) {
                            try {
                                this.charts[chartName].data = newData;
                                this.charts[chartName].update('none');
                            } catch (updateErr) {
                                console.warn(`[Charts] Error actualizando ${chartName}, recreando...`, updateErr);
                                // Destruir el chart corrupto y recrear
                                try { this.charts[chartName].destroy(); } catch (e) { }
                                this.charts[chartName] = null;
                            }
                        }

                        // Crear nuevo chart si no existe
                        if (!this.charts[chartName]) {
                            // Destruir cualquier chart existente en el canvas
                            const existingChart = Chart.getChart(canvas);
                            if (existingChart) {
                                existingChart.destroy();
                            }

                            this.charts[chartName] = new Chart(canvas, {
                                type: chartType,
                                data: newData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    ...chartOptions
                                }
                            });
                        }
                    } catch (err) {
                        console.error(`[Charts] Error en ${chartName}:`, err);
                    }
                },

                updateCharts(data) {
                    // Estatus (doughnut)
                    if (data.estatus_pie?.datasets?.[0]) {
                        this.safeUpdateChart('estatus', 'chart-estatus', 'doughnut', {
                            labels: data.estatus_pie.labels || [],
                            datasets: [{
                                data: data.estatus_pie.datasets[0].data || [],
                                backgroundColor: data.estatus_pie.datasets[0].backgroundColor || []
                            }]
                        }, { plugins: { legend: { position: 'right' } } });
                    }

                    // Mensual (bar)
                    if (data.mensual_bar?.datasets?.[0]) {
                        this.safeUpdateChart('mensual', 'chart-mensual', 'bar', {
                            labels: data.mensual_bar.labels || [],
                            datasets: [{
                                label: data.mensual_bar.datasets[0].label || 'Solicitudes',
                                data: data.mensual_bar.datasets[0].data || [],
                                backgroundColor: data.mensual_bar.datasets[0].backgroundColor || '#00BABB'
                            }]
                        }, { scales: { y: { beginAtZero: true } } });
                    }

                    // Tecnolog√≠a (pie)
                    if (data.tecnologia_pie?.datasets?.[0]) {
                        this.safeUpdateChart('tecnologia', 'chart-tecnologia', 'pie', {
                            labels: data.tecnologia_pie.labels || [],
                            datasets: [{
                                data: data.tecnologia_pie.datasets[0].data || [],
                                backgroundColor: data.tecnologia_pie.datasets[0].backgroundColor || []
                            }]
                        });
                    }

                    // KPI (bar horizontal)
                    if (data.kpi_bar?.datasets?.length) {
                        this.safeUpdateChart('kpi', 'chart-kpi', 'bar', {
                            labels: data.kpi_bar.labels || [],
                            datasets: data.kpi_bar.datasets.map(ds => ({
                                label: ds.label || '',
                                data: ds.data || [],
                                backgroundColor: ds.backgroundColor || '#10B981'
                            }))
                        }, { indexAxis: 'y', scales: { x: { beginAtZero: true } } });
                    }

                    // Motivos (bar horizontal)
                    if (data.motivos_bar?.datasets?.[0]) {
                        this.safeUpdateChart('motivos', 'chart-motivos', 'bar', {
                            labels: data.motivos_bar.labels || [],
                            datasets: [{
                                label: data.motivos_bar.datasets[0].label || 'Motivo',
                                data: data.motivos_bar.datasets[0].data || [],
                                backgroundColor: data.motivos_bar.datasets[0].backgroundColor || '#8B5CF6'
                            }]
                        }, { indexAxis: 'y', scales: { x: { beginAtZero: true } } });
                    }
                }
            };
        };
    </script>

    <!-- Modal de Loading Global -->
    <div id="loading-modal"
        class="htmx-indicator fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
        style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-10">
            <div class="flex flex-col items-center gap-5">
                <!-- Spinner Corporativo Enertika -->
                <div class="spinner-enertika"></div>
                <!-- Texto -->
                <span class="text-lg font-medium text-gray-700">Procesando solicitud...</span>
                <p class="text-sm text-gray-500">Por favor espera un momento</p>
            </div>
        </div>
    </div>

    <!-- Contenedor global para toasts flotantes -->
    <div id="global-toast-container" class="fixed top-5 right-5 z-[10000] pointer-events-none space-y-3"></div>

    <!-- Modal de Documentaci√≥n (Compartido) -->
    {% include "shared/modals/docs_modal.html" %}

</body>

</html>