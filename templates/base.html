<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Enertika Core Ops{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>

    <script>
        const DEBUG_MODE = {{ DEBUG_MODE | tojson }};
        if (!DEBUG_MODE) {
            console.log = function () { };
            console.info = function () { };
            console.debug = function () { };
        }
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('notifications', { count: 0 });
            Alpine.store('activeModule', { slug: '' });
        });
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --enertika-primary: #123456;
            --enertika-secondary: #00BABB;
            --enertika-secondary-dark: #009999;
            --enertika-dark: #0E2A47;
            --enertika-secondary-light: #E0F7F7;
        }

        /* === ANIMACIONES PREMIUM === */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.5;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        @keyframes glow-pulse {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(0, 186, 187, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(0, 186, 187, 0.6), 0 0 30px rgba(0, 186, 187, 0.4);
            }
        }

        @keyframes badge-ping {

            75%,
            100% {
                transform: scale(1.1);
                opacity: 0;
            }
        }

        /* === CLASES DE ANIMACI√ìN === */
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        .animate-pulse-subtle {
            animation: pulse-subtle 2s ease-in-out infinite;
        }

        .animate-slide-in {
            animation: slideInRight 0.3s ease-out;
        }

        .animate-glow-pulse {
            animation: glow-pulse 2s ease-in-out infinite;
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        /* Ripple Effect */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple-effect:active::after {
            width: 300px;
            height: 300px;
        }

        /* Smooth transitions globales */
        * {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Utility classes corporativas */
        .bg-enertika-primary {
            background-color: var(--enertika-primary);
        }

        .bg-enertika-secondary {
            background-color: var(--enertika-secondary);
        }

        .text-enertika-primary {
            color: var(--enertika-primary);
        }

        .text-enertika-secondary {
            color: var(--enertika-secondary);
        }

        .border-enertika-secondary {
            border-color: var(--enertika-secondary);
        }

        /* Loading spinner corporativo */
        .spinner-enertika {
            border: 3px solid #E0F7F7;
            border-top: 3px solid #00BABB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .htmx-indicator {
            display: none !important;
        }

        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Scrollbar personalizado */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0E2A47;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #00BABB;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #009999;
        }

        /* === SIDEBAR PREMIUM STYLES === */

        /* Glassmorphism para sidebar colapsado */
        .sidebar-collapsed {
            background: rgba(18, 52, 86, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Active state indicator */
        .module-link {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .module-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(to bottom, #00BABB, #009999);
            transition: width 0.3s ease;
            border-radius: 0 4px 4px 0;
        }

        .module-link.active::before {
            width: 4px;
        }

        .module-link.active {
            background: linear-gradient(90deg, rgba(0, 186, 187, 0.15) 0%, rgba(0, 186, 187, 0.05) 100%);
            border-left: 3px solid #00BABB;
        }

        .module-link:hover {
            background: rgba(0, 186, 187, 0.08);
            transform: translateX(2px);
        }

        /* Icon animation on hover */
        .module-link:hover .module-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .module-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        /* Group headers */
        .group-header {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(0, 186, 187, 0.7);
            margin-bottom: 0.5rem;
            padding-left: 1rem;
        }

        /* Badge notification with ping animation */
        .notification-badge {
            position: relative;
        }

        .notification-badge::before {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            background: #ef4444;
            animation: badge-ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* User badge hover glow */
        .user-badge:hover {
            box-shadow: 0 0 15px rgba(0, 186, 187, 0.4);
        }

        /* Tooltip premium */
        .tooltip-premium {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-900">

    <div class="flex h-screen overflow-hidden" x-data="{ 
            sidebarOpen: localStorage.getItem('sidebarOpen') !== 'false', 
            mobileMenuOpen: false,
            notificationsOpen: false 
        }" x-init="$watch('sidebarOpen', val => localStorage.setItem('sidebarOpen', val))">

        {% if user_name %}
        <!-- MOBILE HEADER -->
        <header
            class="fixed top-0 left-0 right-0 h-14 bg-[#123456] text-white flex items-center justify-between px-4 z-30 md:hidden shadow-lg">
            <button @click="mobileMenuOpen = true; sidebarOpen = true"
                class="p-2 rounded-lg hover:bg-blue-800/50 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <span class="text-lg font-bold text-[#00BABB]">Enertika</span>
            <div class="relative">
                <span class="text-lg">üë§</span>
                <span x-show="$store.notifications?.count > 0"
                    x-text="$store.notifications?.count > 99 ? '99+' : $store.notifications?.count"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1 rounded-full min-w-[14px] text-center"></span>
            </div>
        </header>

        <!-- MOBILE OVERLAY -->
        <div x-show="mobileMenuOpen" x-transition:enter="transition-opacity ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0" @click="mobileMenuOpen = false"
            class="fixed inset-0 bg-black/60 z-40 md:hidden" style="display: none;"></div>

        <!-- === SIDEBAR PREMIUM === -->
        <aside
            class="bg-[#123456] text-white flex flex-col shadow-2xl z-50 transition-all duration-300 ease-in-out overflow-visible fixed md:relative inset-y-0 left-0 transform md:transform-none"
            :class="[
                sidebarOpen ? 'w-64' : 'w-20 sidebar-collapsed',
                mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'
            ]">

            <!-- LOGO & USER SECTION -->
            <div class="p-4 border-b border-blue-900 bg-[#0E2A47] flex flex-col items-center justify-center transition-all duration-300"
                :class="sidebarOpen ? 'h-32' : 'h-32'">

                <!-- Expanded: Full Title -->
                <h1 x-show="sidebarOpen" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform scale-90"
                    x-transition:enter-end="opacity-100 transform scale-100"
                    class="text-xl font-bold tracking-wider text-[#00BABB] text-center whitespace-nowrap">
                    Enertika Core Ops
                </h1>

                <!-- Collapsed: Mini Icon -->
                <div x-show="!sidebarOpen" x-transition:enter="transition ease-out duration-200 delay-100"
                    x-transition:enter-start="opacity-0 transform rotate-180"
                    x-transition:enter-end="opacity-100 transform rotate-0" class="text-3xl font-black text-[#00BABB]">
                    E
                </div>

                <!-- USER INFO CON NOTIFICACIONES -->
                <div class="mt-3 flex items-center justify-center relative" x-data="{ open: false }">
                    <!-- Expanded: Full Name Badge con Click -->
                    <button x-show="sidebarOpen" @click="open = !open"
                        class="user-badge px-3 py-1 bg-blue-900/50 rounded-full text-xs font-mono text-blue-200 border border-blue-800 whitespace-nowrap max-w-[180px] transition-all duration-200 hover:bg-blue-900/70 cursor-pointer relative">
                        {{ user_name }}
                        <span x-show="$store.notifications?.count > 0"
                            x-text="$store.notifications?.count > 99 ? '99+' : $store.notifications?.count"
                            class="notification-badge ml-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[16px] inline-block">
                        </span>
                    </button>

                    <!-- Collapsed: Initials Circle con Badge -->
                    <button x-show="!sidebarOpen" @click="open = !open"
                        class="user-badge w-10 h-10 flex items-center justify-center bg-blue-900/50 rounded-full text-xs font-mono text-blue-200 border border-blue-800 relative cursor-pointer transition-all duration-200 hover:bg-blue-900/70"
                        title="{{ user_name }}">
                        {{ user_name[:2].upper() if user_name else 'OPS' }}
                        <span x-show="$store.notifications?.count > 0"
                            x-text="$store.notifications?.count > 99 ? '9+' : $store.notifications?.count"
                            class="notification-badge absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px]">
                        </span>
                    </button>

                    <!-- Dropdown de Notificaciones -->
                    <div x-show="open" @click.away="open = false" x-transition
                        class="absolute top-full mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 max-h-96 overflow-hidden z-50"
                        :class="sidebarOpen ? 'left-0' : 'left-12'" style="display: none;">

                        <div
                            class="p-3 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50 flex justify-between items-center">
                            <h3 class="font-semibold text-gray-800">Notificaciones</h3>
                            <button onclick="deleteAllNotifications(event)"
                                class="text-xs text-red-500 hover:text-red-700 font-bold hover:bg-red-50 px-2 py-1 rounded transition">
                                Borrar todas
                            </button>
                        </div>

                        <div id="notifications-dropdown" class="max-h-80 overflow-y-auto">
                            <div id="empty-notifications" class="p-8 text-center text-gray-400 text-sm">
                                <div class="text-4xl mb-2">üì≠</div>
                                <p>No hay notificaciones nuevas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NAVIGATION -->
            <nav class="flex-1 space-y-1 overflow-y-auto overflow-x-hidden text-sm transition-all duration-300 py-4"
                :class="sidebarOpen ? 'px-3 custom-scrollbar' : 'px-2 no-scrollbar'">

                {% set module_groups = {
                'OPERACIONES': [
                {"slug": "comercial", "name": "Comercial", "icon": "üíº", "url": "/comercial/ui"},
                {"slug": "simulacion", "name": "Simulaci√≥n", "icon": "‚ö°", "url": "/simulacion/ui"},
                {"slug": "levantamientos", "name": "Levantamientos", "icon": "üìã", "url": "/levantamientos/ui"}
                ],
                'PROYECTOS': [
                {"slug": "proyectos", "name": "Proyectos", "icon": "üìÅ", "url": "/proyectos/ui"},
                {"slug": "ingenieria", "name": "Ingenier√≠a", "icon": "üèóÔ∏è", "url": "/ingenieria/ui"},
                {"slug": "construccion", "name": "Construcci√≥n", "icon": "üöß", "url": "/construccion/ui"},
                {"slug": "compras", "name": "Compras", "icon": "üõí", "url": "/compras/ui"}
                ],
                'MANTENIMIENTO': [
                {"slug": "oym", "name": "O & M", "icon": "üîß", "url": "/oym/ui"}
                ]
                } %}

                {% for group_name, modules in module_groups.items() %}
                <!-- Group Header (Solo visible cuando est√° expandido) -->
                <div x-show="sidebarOpen" class="group-header mt-4 first:mt-0">
                    {{ group_name }}
                </div>

                <!-- Divider visual cuando est√° colapsado -->
                <div x-show="!sidebarOpen" class="my-3 border-t border-blue-900/30"></div>

                {% for module in modules %}
                {% set has_access = (role == 'ADMIN') or (module.slug in (module_roles or {})) %}

                <div class="relative group">
                    {% if has_access %}
                    <!-- M√ìDULO CON ACCESO -->
                    <a href="#" hx-get="{{ module.url }}" hx-target="#main-content" hx-swap="innerHTML"
                        hx-push-url="true"
                        @click="mobileMenuOpen = false; $store.activeModule.slug = '{{ module.slug }}'"
                        class="module-link flex items-center gap-3 py-3 px-3 rounded-lg transition-all duration-200 overflow-hidden"
                        :class="$store.activeModule.slug === '{{ module.slug }}' ? 'active' : ''"
                        x-init="if (window.location.pathname.includes('{{ module.slug }}')) $store.activeModule.slug = '{{ module.slug }}'">

                        <span class="module-icon text-lg">{{ module.icon }}</span>

                        <span class="font-medium whitespace-nowrap transition-opacity duration-200" x-show="sidebarOpen"
                            x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0"
                            x-transition:enter-end="opacity-100">
                            {{ module.name }}
                        </span>
                    </a>
                    {% else %}
                    <!-- M√ìDULO BLOQUEADO -->
                    <div class="flex items-center gap-3 py-3 px-3 rounded-lg opacity-40 overflow-hidden">
                        <span class="text-lg">{{ module.icon }}</span>
                        <span class="font-medium text-gray-400 whitespace-nowrap" x-show="sidebarOpen">
                            {{ module.name }}
                        </span>
                        <span class="ml-auto text-xs" x-show="sidebarOpen">üîí</span>
                    </div>
                    {% endif %}

                    <!-- TOOLTIP (Solo visible cuando est√° colapsado) -->
                    <div x-show="!sidebarOpen"
                        class="tooltip-premium absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl">
                        {{ module.name }}
                        {% if not has_access %}<span class="ml-1 text-xs text-gray-400">(Bloqueado)</span>{% endif %}
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-gray-900">
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endfor %}

                {% if role == 'ADMIN' %}
                <div class="my-4 border-t border-blue-900/30"></div>
                <div class="relative group">
                    <a href="/admin/ui"
                        class="module-link flex items-center gap-3 py-3 px-3 rounded-lg bg-blue-900/20 hover:bg-blue-800/50 text-yellow-100 border border-transparent hover:border-yellow-500/30 transition-all duration-200 overflow-hidden">
                        <span class="module-icon text-lg">‚öôÔ∏è</span>
                        <span class="font-medium whitespace-nowrap" x-show="sidebarOpen">Admin</span>
                    </a>
                    <div x-show="!sidebarOpen"
                        class="tooltip-premium absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl">
                        Admin
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-gray-900">
                        </div>
                    </div>
                </div>
                {% endif %}
            </nav>

            <!-- AYUDA -->
            <div class="pb-2 border-t border-blue-900/30 mt-2">
                <div class="relative group">
                    <button @click="$dispatch('open-docs-modal')"
                        class="module-link flex items-center gap-3 py-3 px-3 rounded-lg hover:bg-blue-800/50 transition-all duration-200 overflow-hidden w-full"
                        title="Ayuda y Documentaci√≥n">
                        <span class="module-icon text-lg">‚ùì</span>
                        <span class="font-medium whitespace-nowrap" x-show="sidebarOpen">Ayuda</span>
                    </button>

                    <div x-show="!sidebarOpen"
                        class="tooltip-premium absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl">
                        Ayuda y Documentaci√≥n
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-gray-900">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOGGLE BUTTON -->
            <div class="flex justify-center py-2 border-t border-blue-900 bg-[#0E2A47] cursor-pointer hover:bg-blue-800/50 transition-colors"
                @click="sidebarOpen = !sidebarOpen">
                <svg class="w-6 h-6 text-blue-300 transform transition-transform duration-300"
                    :class="sidebarOpen ? 'rotate-0' : 'rotate-180'" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                </svg>
            </div>

            <!-- LOGOUT -->
            <div class="p-2 bg-[#0E2A47] border-t border-blue-900">
                <div class="relative group">
                    <a href="/auth/logout"
                        class="flex items-center gap-2 w-full py-2 px-3 rounded-lg bg-red-900/20 text-red-200 hover:bg-red-900/40 transition-all duration-200 text-sm overflow-hidden">
                        <span class="text-lg">üö™</span>
                        <span class="whitespace-nowrap" x-show="sidebarOpen">Cerrar Sesi√≥n</span>
                    </a>

                    <div x-show="!sidebarOpen"
                        class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-2 bg-red-900 text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap shadow-xl border border-red-800">
                        Cerrar Sesi√≥n
                        <div
                            class="absolute right-full top-1/2 -translate-y-1/2 -mr-1 border-4 border-transparent border-r-red-900">
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        {% endif %}

        <!-- MAIN CONTENT -->
        <main id="main-content"
            class="flex-1 overflow-y-auto relative bg-gray-50 w-full p-4 md:p-6 lg:p-8 pt-18 md:pt-4">
            {% block content %}
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center">
                <h2 class="text-2xl font-light text-gray-400">Selecciona un m√≥dulo del men√∫</h2>
            </div>
            {% endblock %}
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="global-loading-overlay"
        class="htmx-indicator fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[9999] transition-opacity duration-300 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center animate-fade-in-up">
            <div class="spinner-enertika mb-4"></div>
            <p class="text-gray-800 font-bold text-lg">Procesando...</p>
            <p class="text-gray-500 text-sm">Por favor espera un momento.</p>
        </div>
    </div>

    <!-- Session Modal -->
    <div id="session-modal"
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] hidden flex items-center justify-center transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-orange-500 transform scale-100 animate-fade-in-down">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 mb-6">
                <svg class="h-8 w-8 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Sesi√≥n Expirada</h3>
            <p class="text-gray-600 mb-8">Tu conexi√≥n segura ha terminado. <br><strong>No recargues la p√°gina</strong>
                para no perder tu avance.</p>

            <div class="space-y-3">
                <button onclick="reconnectAndWatch()" id="reconnect-btn"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition">
                    üîÑ Re-conectar
                </button>
                <button onclick="document.getElementById('session-modal').classList.add('hidden')"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition">
                    Ya inici√© sesi√≥n, continuar!!!
                </button>
            </div>
        </div>
    </div>

    <script>
        // === FUNCI√ìN DE RECONEXI√ìN ===
        function reconnectAndWatch() {
            const btn = document.getElementById('reconnect-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">Esperando login...</span>';
            btn.disabled = true;

            const popup = window.open('/auth/login', 'LoginPopup', 'width=500,height=600,left=200,top=200');

            const timer = setInterval(() => {
                fetch(window.location.pathname, { method: 'HEAD' })
                    .then(res => {
                        if (res.ok && !res.redirected) {
                            clearInterval(timer);
                            if (popup) popup.close();
                            htmx.ajax('GET', window.location.pathname, { target: '#main-content', swap: 'innerHTML' });
                            document.getElementById('session-modal').classList.add('hidden');
                        }
                    })
                    .catch(() => { });

                if (popup && popup.closed) {
                    // Continuar intentando
                }
            }, 1000);
        }

        // === INTERCEPTOR DE ERRORES 401 ===
        document.body.addEventListener('htmx:responseError', function (evt) {
            if (evt.detail.xhr.status === 401) {
                evt.preventDefault();
                evt.stopPropagation();
                document.getElementById('session-modal').classList.remove('hidden');
            }
        });

        // === HEARTBEAT ===
        setInterval(() => {
            fetch(window.location.pathname, { method: 'HEAD' }).then(res => {
                if (res.redirected || res.status === 401 || res.status === 403) {
                    document.getElementById('session-modal').classList.remove('hidden');
                }
            }).catch(() => { });
        }, 60000);

        // === AUTO-SAVE ===
        document.addEventListener('input', (e) => {
            if (e.target.name && !e.target.type.match(/password|hidden|file/)) {
                localStorage.setItem('draft_' + window.location.pathname + '_' + e.target.name, e.target.value);
            }
        });

        // === RESTORE ===
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.name) {
                    const val = localStorage.getItem('draft_' + window.location.pathname + '_' + input.name);
                    if (val && !input.value) {
                        input.value = val;
                        input.style.borderColor = "#FBBF24";
                    }
                }
            });
        });

        // === CLEANUP ===
        document.body.addEventListener('htmx:afterOnLoad', (evt) => {
            if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
                if (evt.detail.requestConfig.verb !== 'get') {
                    Object.keys(localStorage).forEach(k => {
                        if (k.startsWith('draft_' + window.location.pathname)) localStorage.removeItem(k);
                    });
                }
            }
        });

        // === CHIPS (Correos) ===
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('chip-input') && ['Enter', 'Tab', ';', ','].includes(e.key)) {
                e.preventDefault();
                addChip(e.target);
            }
        });
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('chip-remove')) removeChip(e.target);
        });
        function addChip(input) {
            const container = input.closest('.chip-wrapper');
            const hiddenInput = container.querySelector('.recipients-hidden');
            const chipsContainer = container.querySelector('.chips-container');
            let value = input.value.trim().replace(/[;,]/g, '');
            if (!value) return;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) { alert("Correo inv√°lido"); return; }
            const chip = document.createElement('div');
            chip.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200 mr-2 mb-2 animate-fade-in-down';
            chip.innerHTML = `<span>${value}</span><button type="button" class="chip-remove ml-2 text-blue-500 hover:text-blue-700 font-bold">√ó</button>`;
            chipsContainer.appendChild(chip);
            updateHiddenInput(hiddenInput, chipsContainer);
            input.value = '';
        }
        function removeChip(button) {
            const chip = button.closest('div');
            const container = button.closest('.chip-wrapper');
            chip.remove();
            updateHiddenInput(container.querySelector('.recipients-hidden'), container.querySelector('.chips-container'));
        }
        function updateHiddenInput(hidden, container) {
            hidden.value = Array.from(container.querySelectorAll('span')).map(s => s.textContent).join(';');
        }

        // === TOAST SYSTEM ===
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has('new_op')) {
                const opId = urlParams.get('new_op');
                const esFuera = urlParams.get('fh') === 'true';

                if (esFuera) {
                    const toastHtml = `
                        <div class="bg-white border-l-4 border-orange-500 shadow-lg rounded p-4 mb-4 flex items-center gap-3 animate-fade-in-down w-80 pointer-events-auto">
                            <div class="p-2 rounded-full bg-orange-100 text-orange-600">üåô</div>
                            <div>
                                <p class="font-bold text-gray-800">Oportunidad Creada</p>
                                <p class="text-sm text-gray-600">Ref: ${opId}</p>
                                <p class="text-xs text-orange-600 font-bold mt-1">‚ö†Ô∏è Registrado Fuera de Horario</p>
                            </div>
                            <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600 cursor-pointer">‚úï</button>
                        </div>
                    `;

                    const container = document.getElementById('global-toast-container');
                    if (container) {
                        container.innerHTML = toastHtml;
                        setTimeout(() => {
                            if (container.firstChild) container.firstChild.remove();
                        }, 5000);
                    }
                }

                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // === NOTIFICATIONS SYSTEM (SSE) ===
        let notificationSource = null;
        let unreadCount = 0;

        function initNotifications() {
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Timeout')), 2000)
            );

            Promise.race([
                fetch('/notifications/count').then(r => r.json()),
                timeoutPromise
            ])
                .then(data => {
                    unreadCount = data.unread_count;
                    updateBadges();
                    loadNotifications();
                })
                .catch(() => {
                    console.warn('[Notifications] Timeout inicial, continuando...');
                });

            if (typeof (EventSource) !== "undefined") {
                notificationSource = new EventSource('/notifications/stream');

                notificationSource.addEventListener('notification', function (e) {
                    const data = JSON.parse(e.data);
                    // El backend no env√≠a unread_count en el evento, lo incrementamos localmente
                    unreadCount++;
                    updateBadges();
                    prependNotification(data);
                    showToast(data);
                });

                notificationSource.onerror = function () {
                    console.warn('[SSE] Error de conexi√≥n, reintentando en 5s...');
                    notificationSource.close();
                    setTimeout(initNotifications, 5000);
                };
            }
        }

        function updateBadges() {
            Alpine.store('notifications').count = unreadCount;
        }

        function loadNotifications() {
            fetch('/notifications/list')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('notifications-dropdown');
                    const empty = document.getElementById('empty-notifications');

                    if (data.notifications && data.notifications.length > 0) {
                        // empty.style.display = 'none'; // Don't rely on style if we nuke innerHTML

                        // Save empty div if needed, or just recreate structure?
                        // Better: remove all notification items, keep empty hidden?
                        // Simpler: Just nuke and rebuild. If empty loop, put empty back.
                        container.innerHTML = '';

                        [...data.notifications].reverse().forEach(n => prependNotification(n));
                    } else {
                        // Ensure empty state is visible
                        if (!document.getElementById('empty-notifications')) {
                            container.innerHTML = `
                                <div id="empty-notifications" class="p-8 text-center text-gray-400 text-sm">
                                    <div class="text-4xl mb-2">üì≠</div>
                                    <p>No hay notificaciones nuevas</p>
                                </div>
                             `;
                        } else {
                            document.getElementById('empty-notifications').style.display = 'block';
                        }
                    }
                })
                .catch(() => { });
        }

        function prependNotification(n) {
            const container = document.getElementById('notifications-dropdown');
            const empty = document.getElementById('empty-notifications');
            if (empty) empty.style.display = 'none';

            // Evitar duplicados si ya existe
            if (document.getElementById(`notif-${n.id}`)) return;

            const item = document.createElement('div');
            item.id = `notif-${n.id}`;
            item.className = `p-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition ${n.read ? 'bg-white' : 'bg-blue-50'}`;
            item.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-lg">${n.type === 'info' ? '‚ÑπÔ∏è' : n.type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${n.title}</p>
                        <p class="text-sm text-gray-600 mt-1">${n.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${new Date(n.created_at).toLocaleString()}</p>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 transition p-1 rounded-full hover:bg-red-50" onclick="deleteNotification('${n.id}', event)" title="Eliminar">
                        ‚úï
                    </button>
                </div>
            `;
            item.onclick = () => markAsRead(n.id, item);
            container.prepend(item);
        }

        function markAsRead(id, itemElement) {
            // Optimistic update
            if (itemElement && itemElement.classList.contains('bg-blue-50')) {
                itemElement.classList.remove('bg-blue-50');
                itemElement.classList.add('bg-white');
                unreadCount = Math.max(0, unreadCount - 1);
                updateBadges();
            }

            fetch(`/notifications/mark-read/${id}`, { method: 'POST' })
                .then(r => {
                    if (!r.ok) {
                        // Revert if error?
                        console.error("Error marking read");
                    }
                });
        }

        function deleteNotification(id, event) {
            event.stopPropagation();
            if (!confirm('¬øEliminar notificaci√≥n?')) return;

            fetch(`/notifications/${id}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        const el = document.getElementById(`notif-${id}`);
                        if (el) {
                            if (el.classList.contains('bg-blue-50')) {
                                unreadCount = Math.max(0, unreadCount - 1);
                                updateBadges();
                            }
                            el.remove();
                        }

                        const container = document.getElementById('notifications-dropdown');
                        // Check if any notifications remain (ignoring empty placeholder if present, though innerHTML might have nuked it)
                        // But if we remove one by one, eventually...
                        if (container.querySelectorAll('div[id^="notif-"]').length === 0) {
                            let empty = document.getElementById('empty-notifications');
                            if (!empty) {
                                container.innerHTML = `
                                    <div id="empty-notifications" class="p-8 text-center text-gray-400 text-sm">
                                        <div class="text-4xl mb-2">üì≠</div>
                                        <p>No hay notificaciones nuevas</p>
                                    </div>
                                 `;
                            } else {
                                empty.style.display = 'block';
                            }
                        }
                    }
                });
        }

        function deleteAllNotifications(event) {
            event.stopPropagation();
            if (!confirm('¬øEst√°s seguro de querer eliminar TODAS las notificaciones?')) return;

            fetch('/notifications/all', { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        // Clear UI immediately
                        unreadCount = 0;
                        updateBadges();

                        const container = document.getElementById('notifications-dropdown');
                        container.innerHTML = `
                            <div id="empty-notifications" class="p-8 text-center text-gray-400 text-sm">
                                <div class="text-4xl mb-2">üì≠</div>
                                <p>No hay notificaciones nuevas</p>
                            </div>
                        `;
                    } else {
                        alert("Error eliminando notificaciones");
                    }
                })
                .catch(() => alert("Error de conexi√≥n"));
        }

        function showToast(n) {
            const toastHtml = `
                <div class="bg-white border-l-4 ${n.type === 'success' ? 'border-green-500' : 'border-blue-500'} shadow-lg rounded p-4 mb-4 flex items-center gap-3 animate-fade-in-down w-80 pointer-events-auto">
                    <div class="p-2 rounded-full ${n.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}">
                        ${n.type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}
                    </div>
                    <div>
                        <p class="font-bold text-gray-800">${n.title}</p>
                        <p class="text-sm text-gray-600">${n.message}</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600 cursor-pointer">‚úï</button>
                </div>
            `;

            const container = document.getElementById('global-toast-container');
            if (container) {
                const div = document.createElement('div');
                div.innerHTML = toastHtml;
                container.appendChild(div.firstElementChild);

                setTimeout(() => {
                    if (div.firstElementChild) div.firstElementChild.remove();
                }, 5000);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNotifications);
        } else {
            initNotifications();
        }
    </script>

    <!-- Modal de Loading Global -->
    <div id="loading-modal"
        class="htmx-indicator fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
        style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-10">
            <div class="flex flex-col items-center gap-5">
                <div class="spinner-enertika"></div>
                <span class="text-lg font-medium text-gray-700">Procesando solicitud...</span>
                <p class="text-sm text-gray-500">Por favor espera un momento</p>
            </div>
        </div>
    </div>

    <!-- Contenedor global para toasts flotantes -->
    <div id="global-toast-container" class="fixed top-5 right-5 z-[10000] pointer-events-none space-y-3"></div>

    <!-- Modal de Documentaci√≥n (Compartido) -->
    {% include "shared/modals/docs_modal.html" %}


    <!-- ========== GLOBAL GENERIC MODAL ========== -->
    <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal(event)">
        <div id="modal-container" class="modal-container" onclick="event.stopPropagation()">
            <div id="modal-content">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-container {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 1rem;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }

        .modal-overlay.show .modal-container {
            transform: scale(1);
        }

        /* Common Modal Styles */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.15s;
        }

        .modal-close:hover {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(100, 116, 139, 0.2);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
    </style>

    <script>
        // Global Modal Functions
        window.openModal = function () {
            const overlay = document.getElementById('modal-overlay');
            if (!overlay) return;

            overlay.classList.remove('hidden');
            // Trigger transition
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = function (event) {
            // If event provided (click), check logic
            if (event && event.target.id !== 'modal-overlay') return;

            const overlay = document.getElementById('modal-overlay');
            if (!overlay) return;

            overlay.classList.remove('show');

            setTimeout(() => {
                overlay.classList.add('hidden');
                const content = document.getElementById('modal-content');
                if (content) content.innerHTML = ''; // Clear content
            }, 200);

            // Restore body scroll
            document.body.style.overflow = '';
        };

        // Close with ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('modal-overlay');
                if (overlay && !overlay.classList.contains('hidden')) {
                    // Call closeModal without event to force close
                    try {
                        const ov = document.getElementById('modal-overlay');
                        ov.classList.remove('show');
                        setTimeout(() => {
                            ov.classList.add('hidden');
                            document.getElementById('modal-content').innerHTML = '';
                        }, 200);
                        document.body.style.overflow = '';
                    } catch (e) { }
                }
            }
        });
    </script>
</body>

</html>