<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Enertika Ops Core{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/ext/json-enc.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Variables de Colores Corporativos Enertika */
        :root {
            --enertika-primary: #123456;
            --enertika-secondary: #00BABB;
            --enertika-secondary-dark: #009999;
            --enertika-dark: #0E2A47;
            --enertika-secondary-light: #E0F7F7;
        }

        /* === ANIMACIONES === */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.5;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* === CLASES DE ANIMACI√ìN === */
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        .animate-pulse-subtle {
            animation: pulse-subtle 2s ease-in-out infinite;
        }

        .animate-slide-in {
            animation: slideInRight 0.3s ease-out;
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg,
                    #f0f0f0 0%,
                    #e0e0e0 50%,
                    #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }

        .skeleton-title {
            height: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* Ripple Effect */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple-effect:active::after {
            width: 300px;
            height: 300px;
        }

        /* Smooth transitions globales */
        * {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Utility classes para colores corporativos */
        .bg-enertika-primary {
            background-color: var(--enertika-primary);
        }

        .bg-enertika-secondary {
            background-color: var(--enertika-secondary);
        }

        .text-enertika-primary {
            color: var(--enertika-primary);
        }

        .text-enertika-secondary {
            color: var(--enertika-secondary);
        }

        .border-enertika-secondary {
            border-color: var(--enertika-secondary);
        }

        /* Loading spinner corporativo */
        .spinner-enertika {
            border: 3px solid #E0F7F7;
            border-top: 3px solid #00BABB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* HTMX Indicator - Oculto por defecto, visible durante peticiones */
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator {
            display: flex;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-900">

    <div class="flex h-screen overflow-hidden">
        {% if user_name %}
        <aside class="w-64 bg-[#123456] text-white flex flex-col shadow-2xl z-10 hidden md:flex">
            <div class="p-6 text-center border-b border-blue-900 bg-[#0E2A47]">
                <h1 class="text-xl font-bold tracking-wider text-[#00BABB]">Enertika Ops Core</h1>
                <div
                    class="mt-3 inline-block px-3 py-1 bg-blue-900/50 rounded-full text-xs font-mono text-blue-200 border border-blue-800">
                    {{ user_name }}
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto text-sm">
                <!-- M√≥dulos Principales -->
                {% set all_modules = [
                {"slug": "comercial", "name": "Comercial", "icon": "üíº", "url": "/comercial/ui"},
                {"slug": "simulacion", "name": "Simulaci√≥n", "icon": "‚ö°", "url": "/simulacion/ui"},
                {"slug": "levantamientos", "name": "Levantamientos", "icon": "üìã", "url": "/levantamientos/ui"},
                {"slug": "proyectos", "name": "Proyectos", "icon": "üìÅ", "url": "/proyectos/ui"},
                {"slug": "construccion", "name": "Construcci√≥n", "icon": "üöß", "url": "/construccion/ui"},
                {"slug": "compras", "name": "Compras", "icon": "üõí", "url": "/compras/ui"},
                {"slug": "oym", "name": "O & M", "icon": "üîß", "url": "/oym/ui"}
                ] %}

                {% for module in all_modules %}
                {% set has_access = (role == 'ADMIN') or (module.slug in (module_roles or {})) %}

                <div class="relative group">
                    {% if has_access %}
                    <!-- M√ìDULO CON ACCESO -->
                    <a href="#" hx-get="{{ module.url }}" hx-target="#main-content" hx-swap="innerHTML"
                        hx-push-url="true"
                        class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-800/50 transition duration-150 group/module">
                        <span class="text-lg group-hover/module:scale-110 transition">{{ module.icon }}</span>
                        <span class="font-medium">{{ module.name }}</span>
                    </a>
                    {% else %}
                    <!-- M√ìDULO BLOQUEADO -->
                    <div class="flex items-center gap-3 px-4 py-3 rounded-lg opacity-40">
                        <span class="text-lg">{{ module.icon }}</span>
                        <span class="font-medium text-gray-400">{{ module.name }}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                {% if role == 'ADMIN' %}
                <div class="my-4 border-t border-blue-900/30"></div>
                <a href="/admin/ui"
                    class="flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-900/20 hover:bg-blue-800/50 text-yellow-100 border border-transparent hover:border-yellow-500/30 transition duration-150">
                    <span>‚öôÔ∏è</span> <span class="font-medium">Admin</span>
                </a>
                {% endif %}
            </nav>

            <div class="p-4 bg-[#0E2A47] border-t border-blue-900">
                <a href="/auth/logout"
                    class="flex items-center justify-center gap-2 w-full px-4 py-2 rounded-lg bg-red-900/20 text-red-200 hover:bg-red-900/40 transition duration-150 text-sm">
                    <span>üö™</span> Cerrar Sesi√≥n
                </a>
            </div>
        </aside>
        {% endif %}

        <main id="main-content" class="flex-1 overflow-y-auto relative bg-gray-50 w-full p-4 md:p-6 lg:p-8">
            {% block content %}
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center">
                <h2 class="text-2xl font-light text-gray-400">Selecciona un m√≥dulo del men√∫</h2>
            </div>
            {% endblock %}
        </main>
    </div>

    <div id="session-modal"
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[9999] hidden flex items-center justify-center transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-orange-500 transform scale-100 animate-fade-in-down">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 mb-6">
                <svg class="h-8 w-8 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Sesi√≥n Expirada</h3>
            <p class="text-gray-600 mb-8">Tu conexi√≥n segura ha terminado. <br><strong>No recargues la p√°gina</strong>
                para no perder tu avance.</p>

            <div class="space-y-3">
                <button onclick="reconnectAndWatch()" id="reconnect-btn"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition">
                    üîÑ Re-conectar
                </button>
                <button onclick="document.getElementById('session-modal').classList.add('hidden')"
                    class="w-full inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition">
                    Ya inici√© sesi√≥n, continuar!!!
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- FUNCI√ìN DE RECONEXI√ìN INTELIGENTE ---
        function reconnectAndWatch() {
            const btn = document.getElementById('reconnect-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">Esperando login...</span>';
            btn.disabled = true;

            // 1. Abrir Popup
            const popup = window.open('/auth/login', 'LoginPopup', 'width=500,height=600,left=200,top=200');

            // 2. Iniciar vigilancia (Polling)
            // Preguntamos al servidor cada 1 segundo: "¬øYa revivi√≥ la sesi√≥n?"
            const timer = setInterval(() => {
                fetch('/comercial/form', { method: 'GET' })
                    .then(res => {
                        // Si recibimos OK (200) y NO es una redirecci√≥n al login...
                        if (res.ok && !res.redirected) {
                            // ¬°√âXITO!
                            clearInterval(timer); // Dejar de vigilar

                            if (popup) popup.close(); // Cerrar la ventana hija autom√°ticamente
                            console.log("Sesi√≥n validada. Recargando contenido...");

                            // FIX: Usar HTMX para recargar solo el contenido, no toda la p√°gina
                            htmx.ajax('GET', window.location.pathname, { target: '#main-content', swap: 'innerHTML' });

                            // Cerrar el modal
                            document.getElementById('session-modal').classList.add('hidden');
                        }
                    })
                    .catch(() => { /* Ignorar errores de red mientras esperamos */ });

                // Seguridad: Si el usuario cierra el popup manualmente, dejar de buscar a los 2 minutos
                if (popup && popup.closed) {
                    // Opcional: Podr√≠amos detener el timer, pero mejor seguir intentando un poco m√°s
                }
            }, 1000); // Checar cada 1 segundo
        }

        // --- INTERCEPTOR DE ERRORES 401 (Tu guardi√°n de datos) ---
        document.body.addEventListener('htmx:responseError', function (evt) {
            if (evt.detail.xhr.status === 401) {
                evt.preventDefault();
                evt.stopPropagation();
                document.getElementById('session-modal').classList.remove('hidden');
            }
        });

        // 1. SISTEMA DE ALERTA TEMPRANA (Heartbeat)
        setInterval(() => {
            fetch('/comercial/ui', { method: 'HEAD' }).then(res => {
                if (res.redirected || res.status === 401 || res.status === 403) {
                    document.getElementById('session-modal').classList.remove('hidden');
                }
            }).catch(() => { });
        }, 60000);

        // 2. CAJA FUERTE LOCAL (Auto-Save)
        document.addEventListener('input', (e) => {
            if (e.target.name && !e.target.type.match(/password|hidden|file/)) {
                localStorage.setItem('draft_' + window.location.pathname + '_' + e.target.name, e.target.value);
            }
        });

        // 3. RESTAURACI√ìN AUTOM√ÅTICA
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.name) {
                    const val = localStorage.getItem('draft_' + window.location.pathname + '_' + input.name);
                    if (val && !input.value) {
                        input.value = val;
                        input.style.borderColor = "#FBBF24";
                    }
                }
            });
        });

        // 4. LIMPIEZA POST-ENV√çO
        document.body.addEventListener('htmx:afterOnLoad', (evt) => {
            if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
                if (evt.detail.requestConfig.verb !== 'get') {
                    Object.keys(localStorage).forEach(k => {
                        if (k.startsWith('draft_' + window.location.pathname)) localStorage.removeItem(k);
                    });
                }
            }
        });

        // Scripts de Chips (Correos)
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('chip-input') && ['Enter', 'Tab', ';', ','].includes(e.key)) {
                e.preventDefault();
                addChip(e.target);
            }
        });
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('chip-remove')) removeChip(e.target);
        });
        function addChip(input) {
            const container = input.closest('.chip-wrapper');
            const hiddenInput = container.querySelector('.recipients-hidden');
            const chipsContainer = container.querySelector('.chips-container');
            let value = input.value.trim().replace(/[;,]/g, '');
            if (!value) return;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) { alert("Correo inv√°lido"); return; }
            const chip = document.createElement('div');
            chip.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200 mr-2 mb-2 animate-fade-in-down';
            chip.innerHTML = `<span>${value}</span><button type="button" class="chip-remove ml-2 text-blue-500 hover:text-blue-700 font-bold">√ó</button>`;
            chipsContainer.appendChild(chip);
            updateHiddenInput(hiddenInput, chipsContainer);
            input.value = '';
        }
        function removeChip(button) {
            const chip = button.closest('div');
            const container = button.closest('.chip-wrapper');
            chip.remove();
            updateHiddenInput(container.querySelector('.recipients-hidden'), container.querySelector('.chips-container'));
        }
        function updateHiddenInput(hidden, container) {
            hidden.value = Array.from(container.querySelectorAll('span')).map(s => s.textContent).join(';');
        }

        // === SISTEMA DE TOAST AUTOM√ÅTICO ===
        // Detecta par√°metros en la URL para mostrar mensajes de √©xito despu√©s de redirecciones
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);

            // Detectar creaci√≥n de oportunidad
            if (urlParams.has('new_op')) {
                const opId = urlParams.get('new_op');
                const esFuera = urlParams.get('fh') === 'true';

                // SOLO mostrar toast si es FUERA de horario
                if (esFuera) {
                    const toastHtml = `
                        <div class="bg-white border-l-4 border-orange-500 shadow-lg rounded p-4 mb-4 flex items-center gap-3 animate-fade-in-down w-80">
                            <div class="p-2 rounded-full bg-orange-100 text-orange-600">
                                üåô
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">Oportunidad Creada</p>
                                <p class="text-sm text-gray-600">Ref: ${opId}</p>
                                <p class="text-xs text-orange-600 font-bold mt-1">‚ö†Ô∏è Registrado Fuera de Horario</p>
                            </div>
                            <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                    `;

                    const container = document.getElementById('global-toast-container');
                    if (container) {
                        container.innerHTML = toastHtml;

                        // Autocerrar a los 5 segundos
                        setTimeout(() => {
                            if (container.firstChild) container.firstChild.remove();
                        }, 5000);
                    }
                }

                // Limpiar URL para que no salga al recargar
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>

    <!-- Modal de Loading Global -->
    <div id="loading-modal"
        class="htmx-indicator fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
        style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-10">
            <div class="flex flex-col items-center gap-5">
                <!-- Spinner Corporativo Enertika -->
                <div class="spinner-enertika"></div>
                <!-- Texto -->
                <span class="text-lg font-medium text-gray-700">Procesando solicitud...</span>
                <p class="text-sm text-gray-500">Por favor espera un momento</p>
            </div>
        </div>
    </div>

    <!-- Contenedor global para toasts flotantes -->
    <div id="global-toast-container" class="fixed top-5 right-5 z-50"></div>

</body>

</html>