<div id="kanban-container" class="flex flex-col h-full">
    <!-- Header Premium -->
    <div class="glass-panel p-4 rounded-xl mb-4 flex justify-between items-center border-l-4 border-blue-500">
        <div>
            <h2 class="text-2xl font-light text-gray-800">
                Módulo <span
                    class="font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-500">Levantamientos</span>
            </h2>
            <p class="text-gray-500 text-sm mt-1">Gestión de Levantamientos de Sitio</p>
        </div>
        <div class="flex gap-3">
            <button hx-get="/levantamientos/partials/kanban" hx-target="#kanban-container" hx-swap="outerHTML"
                class="ripple-effect bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 rounded-lg shadow-lg shadow-blue-600/30 flex items-center gap-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Actualizar
            </button>
        </div>
    </div>


    <!-- Kanban Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-1">

        <!-- Column 1: PENDIENTES -->
        <div class="flex flex-col glass-panel rounded-xl shadow-sm h-full border-t-4 border-orange-400"
            x-data="{ open: false }">
            <div class="p-4 border-b border-gray-200/50 cursor-pointer hover:bg-white/50 transition-colors"
                @click="open = !open">
                <h3 class="font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span class="text-xs text-gray-500" x-text="open ? '▼' : '▶'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-orange-600">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Pendientes
                    </span>
                    <span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-base font-bold shadow-sm">{{
                        pendientes|length }}</span>
                </h3>
            </div>

            <!-- Preview Collapsed (Pendientes) -->
            <div x-show="!open" @click="open = true" class="px-2 pb-2 cursor-pointer group">
                {% if pendientes %}
                {% set latest = pendientes[0] %}
                <div
                    class="relative bg-white p-3 rounded shadow-sm border {{ 'border-red-400' if latest.prioridad|lower == 'high' else 'border-gray-200' }} opacity-90 group-hover:opacity-100 transition-all transform group-hover:scale-[1.02]">
                    <!-- Stack effect -->
                    <div
                        class="absolute -bottom-1 left-1 right-1 h-2 bg-gray-50 rounded-b-lg -z-10 border border-t-0 border-gray-200">
                    </div>
                    <div
                        class="absolute -bottom-2 left-2 right-2 h-2 bg-gray-50/50 rounded-b-lg -z-20 border border-t-0 border-gray-100">
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-800 truncate">{{ latest.nombre_proyecto or
                                latest.titulo_proyecto }}</h4>
                            <p class="text-xs text-gray-500 truncate">{{ latest.cliente_nombre }}</p>
                        </div>
                        {% if latest.prioridad|lower == 'high' %}
                        <span class="ml-2 flex h-2 w-2 relative">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% if pendientes|length > 1 %}
                <div class="text-center mt-2">
                    <span class="text-[10px] text-gray-400 font-medium bg-gray-100 px-2 py-0.5 rounded-full">+{{
                        pendientes|length - 1 }} más</span>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-gray-300 text-xs italic">Sin pendientes</div>
                {% endif %}
            </div>
            <div class="p-2 flex-1 overflow-y-auto space-y-3" x-show="open" x-transition>
                {% for item in pendientes %}
                <div
                    class="bg-white p-3 rounded shadow-sm border {{ 'border-red-400 shadow-[0_0_10px_rgba(239,68,68,0.5)]' if item.prioridad|lower == 'high' else 'border-gray-200' }} hover:shadow-md transition-shadow relative">
                    <!-- Priority -->
                    <div class="absolute top-2 right-2">
                        <span
                            class="text-xs font-bold {{ 'text-red-600' if item.prioridad|lower == 'high' else 'text-gray-400' }}">
                            {{ item.prioridad|title }}
                        </span>
                    </div>

                    <div class="mb-2">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">{{ item.cliente_nombre }}</p>
                        <h4 class="font-bold text-sm text-gray-800 leading-tight mt-0.5">{{ item.nombre_proyecto or
                            item.titulo_proyecto }}</h4>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-gray-400 font-mono">{{ item.op_id_estandar }}</p>
                            <p class="text-[10px] text-gray-400 flex items-center gap-1" title="Fecha Solicitud">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                </svg>
                                {{ item.fecha_solicitud.strftime('%d/%m/%Y') if item.fecha_solicitud else '' }}
                            </p>
                        </div>
                    </div>

                    <div class="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center">
                        <div class="flex gap-1">
                            <button hx-get="/levantamientos/modal/assign/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-blue-600 hover:bg-blue-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Asignar Responsables">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3.75 13.5v.75c0 2.123.895 4.118 2.368 5.638a2.122 2.122 0 01.356-.357 6.138 6.138 0 005.35-7.795 3.375 3.375 0 01-1.359 1.498 7.489 7.489 0 01-3.329.808H6.375z" />
                                </svg>
                            </button>
                            <button hx-get="/levantamientos/modal/historial/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Historial">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <button hx-get="/levantamientos/modal/posponer/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-amber-600 hover:bg-amber-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Posponer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                                </svg>
                            </button>
                        </div>
                        <button hx-get="/levantamientos/modal/reagendar/{{ item.id_levantamiento }}?desde=pendiente"
                            hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                            class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded text-xs font-semibold transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-3 h-3 text-blue-500">
                                <path fill-rule="evenodd"
                                    d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z"
                                    clip-rule="evenodd" />
                            </svg>
                            Agendar
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-400 text-sm">No hay pendientes</div>
                {% endfor %}
            </div>
        </div>

        <!-- Column 2: AGENDADOS -->
        <div class="flex flex-col glass-panel rounded-xl shadow-sm h-full border-t-4 border-blue-500"
            x-data="{ open: false }">
            <div class="p-4 border-b border-gray-200/50 cursor-pointer hover:bg-white/50 transition-colors"
                @click="open = !open">
                <h3 class="font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span class="text-xs text-gray-500" x-text="open ? '▼' : '▶'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-blue-600">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                        </svg>
                        Agendados
                    </span>
                    <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-base font-bold shadow-sm">{{
                        agendados|length }}</span>
                </h3>
            </div>

            <!-- Preview Collapsed (Agendados) -->
            <div x-show="!open" @click="open = true" class="px-2 pb-2 cursor-pointer group">
                {% if agendados %}
                {% set latest = agendados[0] %}
                <div
                    class="relative bg-white p-3 rounded shadow-sm border border-gray-200 opacity-90 group-hover:opacity-100 transition-all transform group-hover:scale-[1.02]">
                    <div
                        class="absolute -bottom-1 left-1 right-1 h-2 bg-gray-50 rounded-b-lg -z-10 border border-t-0 border-gray-200">
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-800 truncate">{{ latest.nombre_proyecto or
                                latest.titulo_proyecto }}</h4>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-xs">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                        class="w-3 h-3 text-gray-400">
                                        <path fill-rule="evenodd"
                                            d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </span>
                                <span class="text-xs text-gray-500 truncate">{{ latest.tecnico_nombre or 'Sin asignar'
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% if agendados|length > 1 %}
                <div class="text-center mt-2">
                    <span class="text-[10px] text-blue-400 font-medium bg-blue-50 px-2 py-0.5 rounded-full">+{{
                        agendados|length - 1 }} más</span>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-gray-300 text-xs italic">Nada agendado</div>
                {% endif %}
            </div>
            <div class="p-2 flex-1 overflow-y-auto space-y-3" x-show="open" x-transition>
                {% for item in agendados %}
                <div
                    class="bg-white p-3 rounded shadow-sm border {{ 'border-red-400 shadow-[0_0_10px_rgba(239,68,68,0.5)]' if item.prioridad|lower == 'high' else 'border-gray-200' }} hover:shadow-md transition-shadow">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-0.5">{{ item.cliente_nombre }}
                    </p>
                    <h4
                        class="font-bold text-sm {{ 'text-red-700' if item.prioridad|lower == 'high' else 'text-gray-800' }}">
                        {{ item.nombre_proyecto or item.titulo_proyecto }}</h4>

                    <!-- Asignados -->
                    <div class="bg-gray-50 p-2 rounded text-xs space-y-1 mt-2">
                        <div class="flex items-center gap-1 text-gray-600">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    class="w-3 h-3 text-gray-500">
                                    <path
                                        d="M11 5a3 3 0 11-6 0 3 3 0 016 0zM2.615 16.428a1.224 1.224 0 01-.569-1.175 6.002 6.002 0 0111.908 0c.058.467-.172.92-.57 1.174A9.953 9.953 0 017 18a9.953 9.953 0 01-4.385-1.572z" />
                                </svg>
                            </span> <span>{{ item.tecnico_nombre or 'Sin asignar' }}</span>
                        </div>
                        <div class="flex items-center gap-1 text-gray-500">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    class="w-3 h-3 text-gray-400">
                                    <path fill-rule="evenodd"
                                        d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm2.5 7a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm2.45 4a2.5 2.5 0 10-4.9 0h4.9zM12 9a1 1 0 100 2h3a1 1 0 100-2h-3zm-1 4a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z"
                                        clip-rule="evenodd" />
                                </svg>
                            </span> <span>{{ item.jefe_nombre or 'Sin jefe' }}</span>
                        </div>
                    </div>

                    <div class="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center">
                        <div class="flex gap-1">
                            <button hx-get="/levantamientos/modal/assign/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-blue-600 hover:bg-blue-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Asignar Responsables">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3.75 13.5v.75c0 2.123.895 4.118 2.368 5.638a2.122 2.122 0 01.356-.357 6.138 6.138 0 005.35-7.795 3.375 3.375 0 01-1.359 1.498 7.489 7.489 0 01-3.329.808H6.375z" />
                                </svg>
                            </button>
                            <button hx-get="/levantamientos/modal/historial/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Historial">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <button hx-get="/levantamientos/modal/posponer/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-amber-600 hover:bg-amber-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Posponer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                                </svg>
                            </button>
                            <button hx-get="/levantamientos/modal/viaticos/{{ item.id_levantamiento }}"
                                hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                class="text-gray-500 hover:text-emerald-600 hover:bg-emerald-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Viáticos">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                        </div>
                        <button hx-post="/levantamientos/change-status/{{ item.id_levantamiento }}"
                            hx-vals='{"nuevo_estado": 10}' hx-target="#kanban-container" hx-swap="outerHTML"
                            class="bg-yellow-50 text-yellow-600 hover:bg-yellow-100 px-3 py-1.5 rounded text-sm font-semibold transition-colors flex items-center gap-1">
                            <span class="text-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                                </svg>
                            </span> Iniciar
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-400 text-sm">Nada agendado</div>
                {% endfor %}
            </div>
        </div>

        <!-- Column 3: EN PROCESO -->
        <div class="flex flex-col glass-panel rounded-xl shadow-sm h-full border-t-4 border-yellow-500"
            x-data="{ open: false }">
            <div class="p-4 border-b border-gray-200/50 cursor-pointer hover:bg-white/50 transition-colors"
                @click="open = !open">
                <h3 class="font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span class="text-xs text-gray-500" x-text="open ? '▼' : '▶'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-yellow-600">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.033a.263.263 0 01.379-.034l3.178 3.178a.263.263 0 01.034.379l-3.033 2.496M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
                        </svg>
                        En Proceso
                    </span>
                    <span class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-base font-bold shadow-sm">{{
                        en_proceso|length }}</span>
                </h3>
            </div>

            <!-- Preview Collapsed (En Proceso) -->
            <div x-show="!open" @click="open = true" class="px-2 pb-2 cursor-pointer group">
                {% if en_proceso %}
                {% set latest = en_proceso[0] %}
                <div
                    class="relative bg-white p-3 rounded shadow-sm border border-yellow-200 opacity-90 group-hover:opacity-100 transition-all transform group-hover:scale-[1.02]">
                    <div
                        class="absolute -bottom-1 left-1 right-1 h-2 bg-gray-50 rounded-b-lg -z-10 border border-t-0 border-yellow-100">
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-800 truncate">{{ latest.nombre_proyecto or
                                latest.titulo_proyecto }}</h4>
                            <p class="text-xs text-yellow-600 mt-0.5 truncate flex items-center gap-1">
                                <span class="animate-pulse">●</span> {{ latest.tiempo_relativo }}
                            </p>
                        </div>
                    </div>
                </div>
                {% if en_proceso|length > 1 %}
                <div class="text-center mt-2">
                    <span class="text-[10px] text-yellow-600 font-medium bg-yellow-50 px-2 py-0.5 rounded-full">+{{
                        en_proceso|length - 1 }} más</span>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-gray-300 text-xs italic">Nada en proceso</div>
                {% endif %}
            </div>
            <div class="p-2 flex-1 overflow-y-auto space-y-3" x-show="open" x-transition>
                {% for item in en_proceso %}
                <div
                    class="bg-white p-3 rounded shadow-sm border {{ 'border-red-400 shadow-[0_0_10px_rgba(239,68,68,0.5)]' if item.prioridad|lower == 'high' else 'border-gray-200' }} hover:shadow-md transition-shadow">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-0.5">{{ item.cliente_nombre }}
                    </p>
                    <h4
                        class="font-bold text-sm {{ 'text-red-700' if item.prioridad|lower == 'high' else 'text-gray-800' }}">
                        {{ item.nombre_proyecto or item.titulo_proyecto }}</h4>

                    <div class="text-xs text-gray-400 mt-2">
                        <div class="text-xs text-yellow-600 mt-2 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-3 h-3 animate-pulse">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z"
                                    clip-rule="evenodd" />
                            </svg> {{ item.tiempo_relativo }}
                        </div>

                        <div class="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center">
                            <div class="flex gap-1">
                                <button hx-get="/levantamientos/modal/posponer/{{ item.id_levantamiento }}"
                                    hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                    class="text-gray-500 hover:text-amber-600 hover:bg-amber-50 px-1.5 py-1.5 rounded-full transition-all"
                                    title="Posponer">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                                    </svg>
                                </button>
                                <button hx-get="/levantamientos/modal/viaticos/{{ item.id_levantamiento }}"
                                    hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                                    class="text-gray-500 hover:text-emerald-600 hover:bg-emerald-50 px-1.5 py-1.5 rounded-full transition-all"
                                    title="Viáticos">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                            </div>
                            <button hx-post="/levantamientos/change-status/{{ item.id_levantamiento }}"
                                hx-vals='{"nuevo_estado": 11}' hx-target="#kanban-container" hx-swap="outerHTML"
                                class="bg-green-50 text-green-600 hover:bg-green-100 px-3 py-1.5 rounded text-sm font-semibold transition-colors flex items-center gap-1">
                                <span class="text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </span> Completar
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-400 text-sm">Nada en proceso</div>
                {% endfor %}
            </div>
        </div>


        <!-- Column 4: COMPLETADOS -->
        <div class="flex flex-col glass-panel rounded-xl shadow-sm h-full border-t-4 border-green-500"
            x-data="{ open: false }">
            <div class="p-4 border-b border-gray-200/50 cursor-pointer hover:bg-white/50 transition-colors"
                @click="open = !open">
                <h3 class="font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span class="text-xs text-gray-500" x-text="open ? '▼' : '▶'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-green-600">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Completados
                    </span>
                    <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-base font-bold shadow-sm">{{
                        completados|length }}</span>
                </h3>
            </div>

            <!-- Preview Collapsed (Completados) -->
            <div x-show="!open" @click="open = true" class="px-2 pb-2 cursor-pointer group">
                {% if completados %}
                {% set latest = completados[0] %}
                <div
                    class="relative bg-white p-3 rounded shadow-sm border border-green-200 opacity-90 group-hover:opacity-100 transition-all transform group-hover:scale-[1.02]">
                    <div
                        class="absolute -bottom-1 left-1 right-1 h-2 bg-gray-50 rounded-b-lg -z-10 border border-t-0 border-green-100">
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-800 truncate">{{ latest.nombre_proyecto or
                                latest.titulo_proyecto }}</h4>
                            <p class="text-xs text-green-600 mt-0.5">Listo para entregar</p>
                        </div>
                        <span class="text-green-500 text-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-4 h-4">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                                    clip-rule="evenodd" />
                            </svg>
                        </span>
                    </div>
                </div>
                {% if completados|length > 1 %}
                <div class="text-center mt-2">
                    <span class="text-[10px] text-green-600 font-medium bg-green-50 px-2 py-0.5 rounded-full">+{{
                        completados|length - 1 }} más</span>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-gray-300 text-xs italic">Nada completado</div>
                {% endif %}
            </div>
            <div class="p-2 flex-1 overflow-y-auto space-y-3" x-show="open" x-transition>
                {% for item in completados %}
                <div class="bg-white p-3 rounded shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-0.5">{{ item.cliente_nombre
                        }}</p>
                    <h4 class="font-bold text-sm text-gray-800">{{ item.nombre_proyecto or item.titulo_proyecto }}
                    </h4>

                    <div class="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center">
                        <div class="flex gap-1">
                            <a href="/levantamientos/reporte-gastos/{{ item.id_levantamiento }}"
                                target="_blank"
                                class="text-gray-500 hover:text-emerald-600 hover:bg-emerald-50 px-1.5 py-1.5 rounded-full transition-all"
                                title="Descargar Reporte de Gastos">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                            </a>
                        </div>
                        <button hx-get="/levantamientos/modal/entrega/{{ item.id_levantamiento }}"
                            hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                            class="bg-green-50 text-green-700 hover:bg-green-100 px-3 py-1.5 rounded text-sm font-semibold transition-colors flex items-center gap-1">
                            <span class="text-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                                </svg>
                            </span> Entregar
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-400 text-sm">Nada completado</div>
                {% endfor %}
            </div>
        </div>

        <!-- Column 5: ENTREGADOS -->
        <div class="flex flex-col glass-panel rounded-xl shadow-sm h-full border-t-4 border-green-700"
            x-data="{ open: false }">
            <div class="p-4 border-b border-gray-200/50 cursor-pointer hover:bg-white/50 transition-colors"
                @click="open = !open">
                <h3 class="font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span class="text-xs text-gray-500" x-text="open ? '▼' : '▶'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-green-700">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                        </svg>
                        Entregados
                    </span>
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-base font-bold shadow-sm">{{
                        entregados|length }}</span>
                </h3>
            </div>

            <!-- Preview Collapsed (Entregados) -->
            <div x-show="!open" @click="open = true" class="px-2 pb-2 cursor-pointer group">
                {% if entregados %}
                {% set latest = entregados[0] %}
                <div
                    class="relative bg-white/60 p-3 rounded shadow-sm border border-gray-100 opacity-80 group-hover:opacity-100 transition-all transform group-hover:scale-[1.02]">
                    <div
                        class="absolute -bottom-1 left-1 right-1 h-2 bg-gray-50 rounded-b-lg -z-10 border border-t-0 border-gray-100">
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-600 truncate">{{ latest.nombre_proyecto or
                                latest.titulo_proyecto }}</h4>
                            <p class="text-xs text-gray-400 truncate">{{ latest.cliente_nombre }}</p>
                        </div>
                        <span class="text-gray-400 text-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-4 h-4">
                                <path
                                    d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V9.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15.211 6.276a1 1 0 000-1.788l-4.764-2.382a1 1 0 00-.894 0L4.789 4.488a1 1 0 000 1.788l4.764 2.382a1 1 0 00.894 0l4.764-2.382zM4.447 8.342A1 1 0 003 9.236V15a1 1 0 00.553.894l4 2A1 1 0 009 17v-5.764a1 1 0 00-.553-.894l-4-2z" />
                            </svg>
                        </span>
                    </div>
                </div>
                {% if entregados|length > 1 %}
                <div class="text-center mt-2">
                    <span class="text-[10px] text-gray-400 font-medium bg-gray-100 px-2 py-0.5 rounded-full">+{{
                        entregados|length - 1 }} más</span>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-gray-300 text-xs italic">Nada entregado</div>
                {% endif %}
            </div>
            <div class="p-2 flex-1 overflow-y-auto space-y-3" x-show="open" x-transition
                x-data="{ showAll: false, maxItems: 8 }">
                {% for item in entregados %}
                <div x-show="showAll || {{ loop.index }} <= maxItems"
                    class="bg-white/80 p-3 rounded-lg shadow-sm border border-gray-200/50 opacity-75 hover:opacity-100 transition-all hover:shadow-md">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-0.5">{{ item.cliente_nombre
                        }}</p>
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-sm text-gray-600">{{ item.nombre_proyecto or item.titulo_proyecto
                            }}
                        </h4>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            class="w-5 h-5 text-green-600">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <p class="text-xs text-gray-400 mt-0.5">{{ item.op_id_estandar }}</p>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-400 text-sm">Nada entregado</div>
                {% endfor %}

                <!-- Ver más / Ver menos -->
                {% if entregados|length > 8 %}
                <div class="text-center pt-2">
                    <button @click="showAll = !showAll"
                        class="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                        <span x-show="!showAll">Ver todos ({{ entregados|length - 8 }} más) ↓</span>
                        <span x-show="showAll">Mostrar menos ↑</span>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Column 6: POSPUESTOS -->
        <div class="flex flex-col glass-panel rounded-xl shadow-sm h-full border-t-4 border-gray-500"
            x-data="{ open: false }">
            <div class="p-4 border-b border-gray-200/50 cursor-pointer hover:bg-white/50 transition-colors"
                @click="open = !open">
                <h3 class="font-bold text-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span class="text-xs text-gray-500" x-text="open ? '▼' : '▶'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-gray-500">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M14.25 9v6m-4.5 0V9M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Pospuestos
                    </span>
                    <span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-base font-bold shadow-sm">{{
                        pospuestos|length }}</span>
                </h3>
            </div>

            <!-- Preview Collapsed (Pospuestos) -->
            <div x-show="!open" @click="open = true" class="px-2 pb-2 cursor-pointer group">
                {% if pospuestos %}
                {% set latest = pospuestos[0] %}
                <div
                    class="relative bg-white p-3 rounded shadow-sm border border-gray-300 opacity-90 group-hover:opacity-100 transition-all transform group-hover:scale-[1.02]">
                    <div
                        class="absolute -bottom-1 left-1 right-1 h-2 bg-gray-50 rounded-b-lg -z-10 border border-t-0 border-gray-200">
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-600 truncate">{{ latest.nombre_proyecto or
                                latest.titulo_proyecto }}</h4>
                            <p class="text-xs text-gray-500 truncate">Pospuesto</p>
                        </div>
                        <span class="text-gray-400 text-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-4 h-4">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                        </span>
                    </div>
                </div>
                {% if pospuestos|length > 1 %}
                <div class="text-center mt-2">
                    <span class="text-[10px] text-gray-500 font-medium bg-gray-100 px-2 py-0.5 rounded-full">+{{
                        pospuestos|length - 1 }} más</span>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-gray-300 text-xs italic">Sin pospuestos</div>
                {% endif %}
            </div>
            <div class="p-2 flex-1 overflow-y-auto space-y-3" x-show="open" x-transition>
                {% for item in pospuestos %}
                <div
                    class="bg-white p-3 rounded shadow-sm border border-gray-200 opacity-60 hover:opacity-100 transition-opacity">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-0.5">{{ item.cliente_nombre
                        }}</p>
                    <h4 class="font-bold text-sm text-gray-600">{{ item.nombre_proyecto or item.titulo_proyecto }}
                    </h4>

                    <div class="mt-3 pt-2 border-t border-gray-100 flex justify-end gap-2">
                        <button hx-get="/levantamientos/modal/reagendar/{{ item.id_levantamiento }}?desde=pospuesto"
                            hx-target="#modal-content" hx-swap="innerHTML" onclick="openModal()"
                            class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded text-xs font-semibold transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-3 h-3 text-blue-500">
                                <path fill-rule="evenodd"
                                    d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z"
                                    clip-rule="evenodd" />
                            </svg> Reagendar
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-400 text-sm">Sin pospuestos</div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

{% if notification %}
{% with title=notification.title, message=notification.message, type=notification.type %}
{% include "shared/toast.html" %}
{% endwith %}
{% endif %}