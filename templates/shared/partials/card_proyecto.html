{# Card reutilizable de proyecto - usado en listas de todos los modulos #}
{% macro render_card(p, area, area_destino=None, puede_enviar=False, puede_recibir=False, vista_global=False) %}
{% set area_colors = {
    'INGENIERIA': {'bg': 'bg-purple-100', 'text': 'text-purple-800', 'border': 'border-purple-300'},
    'CONSTRUCCION': {'bg': 'bg-amber-100', 'text': 'text-amber-800', 'border': 'border-amber-300'},
    'OYM': {'bg': 'bg-emerald-100', 'text': 'text-emerald-800', 'border': 'border-emerald-300'},
} %}
{% set colors = area_colors.get(p.area_actual, {'bg': 'bg-gray-100', 'text': 'text-gray-800', 'border': 'border-gray-300'}) %}

<div class="glass-card p-4 rounded-xl hover:-translate-y-1 transition-all duration-300 border-l-4 {{ colors.border }}">
    <div class="flex justify-between items-start">
        <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-sm font-mono font-bold text-gray-800">
                    {{ p.proyecto_id_estandar or 'Sin ID' }}
                </span>
                <span class="px-2 py-0.5 text-xs font-bold rounded-lg {{ colors.bg }} {{ colors.text }} {{ colors.border }} border">
                    {{ p.area_actual or 'N/A' }}
                </span>
                {% if p.ultimo_traspaso_status == 'ENVIADO' %}
                <span class="px-2 py-0.5 text-xs font-bold rounded-lg bg-blue-100 text-blue-800 border border-blue-300 animate-pulse-subtle">
                    Traspaso Pendiente
                </span>
                {% endif %}
            </div>
            <p class="text-xs text-gray-600 truncate">{{ p.nombre_proyecto or p.nombre_corto or '' }}</p>
            <p class="text-xs text-gray-500 mt-1">
                <span class="font-medium">Cliente:</span> {{ p.cliente_nombre or 'N/A' }}
            </p>
        </div>
        <div class="text-right flex-shrink-0 ml-4">
            <div class="text-xs text-gray-500">Dias en area</div>
            <div class="text-lg font-bold {% if p.dias_en_area and p.dias_en_area > 30 %}text-red-600{% elif p.dias_en_area and p.dias_en_area > 15 %}text-amber-600{% else %}text-gray-700{% endif %}">
                {{ p.dias_en_area or 0 }}
            </div>
        </div>
    </div>

    {# Barra de progreso visual #}
    <div class="mt-3 flex items-center gap-1">
        {% set areas_flow = ['INGENIERIA', 'CONSTRUCCION', 'OYM'] %}
        {% for a in areas_flow %}
        {% set is_current = (p.area_actual == a) %}
        {% set is_past = areas_flow.index(a) < areas_flow.index(p.area_actual) if p.area_actual in areas_flow else false %}
        <div class="flex-1 h-2 rounded-full {% if is_current %}bg-blue-500{% elif is_past %}bg-green-400{% else %}bg-gray-200{% endif %}"></div>
        {% if not loop.last %}
        <svg class="w-3 h-3 {% if is_past %}text-green-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        {% endif %}
        {% endfor %}
    </div>
    <div class="mt-1 flex justify-between text-[10px] text-gray-400 uppercase">
        <span>Ing</span><span>Const</span><span>O&M</span>
    </div>

    {# Acciones #}
    <div class="mt-3 flex gap-2 justify-end">
        {# Timeline #}
        <button hx-get="/transfers/timeline/{{ p.id_proyecto }}" hx-target="body" hx-swap="beforeend"
            class="text-xs px-2 py-1 rounded border border-gray-300 text-gray-600 hover:bg-gray-100 transition">
            Timeline
        </button>

        {% if puede_enviar and area_destino and p.area_actual == area and p.ultimo_traspaso_status != 'ENVIADO' %}
        {% set module_prefix = {'INGENIERIA': 'ingenieria', 'CONSTRUCCION': 'construccion'}.get(area, '') %}
        <button hx-get="/{{ module_prefix }}/modal/enviar/{{ p.id_proyecto }}" hx-target="body" hx-swap="beforeend"
            class="text-xs px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition font-medium">
            Enviar a {{ {'CONSTRUCCION': 'Construccion', 'OYM': 'O&M'}.get(area_destino, area_destino) }}
        </button>
        {% endif %}
    </div>
</div>
{% endmacro %}
