<div id="sitios-container-{{ id_oportunidad }}"
    x-data="{ selected: [], batchStatus: '{{ estatus_options[0].id if estatus_options else 1 }}' }">

    {% if context.module_role in ['editor', 'admin'] or context.role == 'ADMIN' %}
    <div x-show="selected.length > 0"
        class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between animate-fade-in-down"
        style="display: none;">
        <span class="text-sm text-blue-800 font-bold">
            <span x-text="selected.length"></span> sitios seleccionados
        </span>
        <div class="flex space-x-2">
            <select x-model="batchStatus" class="text-sm border-gray-300 rounded shadow-sm">
                {% for st in estatus_options %}
                <option value="{{ st.id }}">{{ st.nombre }}</option>
                {% endfor %}
            </select>
            <button class="px-3 py-1 bg-blue-600 text-white text-sm font-bold rounded hover:bg-blue-700 shadow-sm"
                hx-put="/simulacion/sitios/batch-update" hx-ext="json-enc"
                :hx-vals="JSON.stringify({ ids_sitios: selected, id_estatus_global: parseInt(batchStatus) })"
                hx-target="#sitios-container-{{ id_oportunidad }}" @htmx:after-request="selected = []">
                Actualizar
            </button>
        </div>
    </div>
    {% endif %}

    <div class="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
        <table class="min-w-full divide-y divide-gray-300">
            <thead class="bg-gray-50">
                <tr>
                    {% if context.module_role in ['editor', 'admin'] or context.role == 'ADMIN' %}
                    <th scope="col" class="px-3 py-3.5 w-10">
                        <input type="checkbox"
                            @change="selected.length === {{ sitios|length }} ? selected = [] : selected = [{% for s in sitios %}'{{ s.id_sitio }}'{% if not loop.last %},{% endif %}{% endfor %}]"
                            :checked="selected.length > 0 && selected.length === {{ sitios|length }}"
                            class="rounded border-gray-300 text-[#00BABB] focus:ring-[#00BABB]">
                    </th>
                    {% endif %}
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Sitio</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Dirección</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Estatus</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Cierre</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Retrabajo</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                {% for sitio in sitios %}
                <tr class="hover:bg-gray-50 transition-colors">
                    {% if context.module_role in ['editor', 'admin'] or context.role == 'ADMIN' %}
                    <td class="px-3 py-4 text-sm text-gray-500">
                        <input type="checkbox" value="{{ sitio.id_sitio }}" x-model="selected"
                            class="rounded border-gray-300 text-[#00BABB] focus:ring-[#00BABB]">
                    </td>
                    {% endif %}
                    <td class="px-3 py-4 text-sm font-medium text-gray-900">{{ sitio.nombre_sitio }}</td>
                    <td class="px-3 py-4 text-sm text-gray-500">{{ sitio.direccion|truncate(40) }}</td>
                    <td class="px-3 py-4 text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if sitio.id_estatus_global == 4 %} bg-green-100 text-green-800
                            {% elif sitio.id_estatus_global == 5 %} bg-red-100 text-red-800
                            {% else %} bg-yellow-100 text-yellow-800 {% endif %}">
                            {{ sitio.nombre_estatus }}
                        </span>
                    </td>
                    <td class="px-3 py-4 text-sm text-gray-500">
                        {{ sitio.fecha_cierre|time_mx if sitio.fecha_cierre else '-' }}
                    </td>
                    <td class="px-3 py-4 text-sm">
                        {% if sitio.es_retrabajo %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-cyan-100 text-cyan-800">
                            <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Sí
                        </span>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>