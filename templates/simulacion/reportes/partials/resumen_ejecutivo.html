{# templates/simulacion/reportes/partials/resumen_ejecutivo.html #}
{# Resumen Ejecutivo V2 - Estructura profesional para directores/gerentes #}

<details class="group mb-8" open>
    <summary
        class="flex items-center justify-between cursor-pointer p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors mb-4">
        <h3 class="text-xl font-bold text-gray-900">Resumen Ejecutivo General</h3>
        <span class="text-gray-500 group-open:rotate-180 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </span>
    </summary>

    <div class="prose max-w-none space-y-6 px-2">

        {# ============================================ #}
        {# SECCI√ìN 1: GESTI√ìN DE DEMANDA #}
        {# ============================================ #}
        <div>
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b pb-1">Gesti√≥n de Demanda
            </h4>
            <p class="text-gray-700 leading-relaxed text-sm">
                Durante el per√≠odo del <strong>{{ resumen.fecha_inicio_formatted }}</strong> al
                <strong>{{ resumen.fecha_fin_formatted }}</strong>, se captaron
                <strong>{{ resumen.total_solicitudes }} solicitudes</strong>.
                La capacidad operativa permiti√≥ procesar <strong>{{ resumen.total_ofertas }} ofertas</strong>,
                con <strong>{{ resumen.en_espera }}</strong> casos en espera al cierre.
                {% if resumen.diferencia_explicacion %}
                <br><span class="text-gray-500 italic text-xs">({{ resumen.diferencia_explicacion }})</span>
                {% endif %}
            </p>
            <p class="text-gray-700 leading-relaxed text-sm mt-2">
                <strong>Mix de Solicitudes:</strong>
                {% for tipo in resumen.top_tipos %}
                {{ tipo.nombre }} ({{ tipo.total }} - {{ tipo.porcentaje }}%){% if not loop.last %}, {% endif %}
                {% endfor %}.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {# ============================================ #}
            {# SECCI√ìN 2: INDICADORES DE CUMPLIMIENTO #}
            {# ============================================ #}
            <div>
                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b pb-1">Indicadores de
                    Cumplimiento</h4>
                <div class="text-sm text-gray-700 space-y-2">
                    <p>Base: <strong>{{ resumen.total_entregas_interno }} solicitudes evaluables</strong>.</p>

                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                        <span>SLA Interno:</span>
                        <span
                            class="font-bold {% if resumen.porcentaje_cumplimiento_interno >= 90 %}text-green-600{% elif resumen.porcentaje_cumplimiento_interno >= 85 %}text-amber-600{% else %}text-red-600{% endif %}">
                            {{ resumen.porcentaje_cumplimiento_interno }}%
                        </span>
                    </div>

                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                        <span>Compromiso Cliente:</span>
                        <span
                            class="font-bold {% if resumen.porcentaje_cumplimiento_compromiso >= 90 %}text-green-600{% elif resumen.porcentaje_cumplimiento_compromiso >= 85 %}text-amber-600{% else %}text-red-600{% endif %}">
                            {{ resumen.porcentaje_cumplimiento_compromiso }}%
                        </span>
                    </div>
                </div>
            </div>

            {# ============================================ #}
            {# SECCI√ìN 5: CALIDAD #}
            {# ============================================ #}
            <div>
                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b pb-1">Calidad y
                    Complejidad</h4>
                <ul class="text-sm text-gray-700 space-y-1">
                    <li>‚Ä¢ <strong>{{ resumen.licitaciones }}</strong> Licitaciones ({{ resumen.porcentaje_licitaciones
                        }}%)</li>
                    <li>‚Ä¢ <strong>{{ resumen.extraordinarias }}</strong> Extraordinarias ({{
                        resumen.porcentaje_extraordinarias }}%)</li>
                    <li>‚Ä¢ <strong>{{ resumen.versiones }}</strong> Actualizaciones de alcance ({{
                        resumen.porcentaje_versiones }}%)</li>
                </ul>
                {% if resumen.total_retrabajos > 0 %}
                <div class="mt-2 text-xs bg-red-50 text-red-800 p-2 rounded border border-red-100">
                    <strong>‚ö†Ô∏è Retrabajos:</strong> {{ resumen.total_retrabajos }} casos ({{
                    resumen.porcentaje_retrabajos }}%)
                    {% if resumen.motivo_retrabajo_principal %}
                    <br>Principal causa: "{{ resumen.motivo_retrabajo_principal }}" ({{ resumen.conteo_motivo_principal
                    }})
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        {# ============================================ #}
        {# SECCI√ìN 3: AN√ÅLISIS POR TECNOLOG√çA #}
        {# ============================================ #}
        {% if resumen.tecnologias_detalle %}
        <div>
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b pb-1">Desempe√±o por
                Tecnolog√≠a</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600">
                            <th class="text-left py-2 px-2 font-semibold">Tecnolog√≠a</th>
                            <th class="text-center py-2 px-2 font-semibold">Solicitudes</th>
                            <th class="text-center py-2 px-2 font-semibold">Ofertas</th>
                            <th class="text-center py-2 px-2 font-semibold">SLA Interno</th>
                            <th class="text-center py-2 px-2 font-semibold">Compromiso</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for tech in resumen.tecnologias_detalle %}
                        <tr
                            class="{% if resumen.peor_tecnologia and tech.nombre == resumen.peor_tecnologia.nombre %}bg-red-50{% elif resumen.mejor_tecnologia and tech.nombre == resumen.mejor_tecnologia.nombre %}bg-green-50{% endif %}">
                            <td class="py-2 px-2 text-gray-700 font-medium">
                                {{ tech.nombre }}
                                {% if resumen.mejor_tecnologia and tech.nombre == resumen.mejor_tecnologia.nombre %}
                                <span class="text-green-600 ml-1 text-[10px]">‚ñ≤ L√≠der</span>
                                {% endif %}
                                {% if resumen.peor_tecnologia and tech.nombre == resumen.peor_tecnologia.nombre %}
                                <span class="text-red-600 ml-1 text-[10px]">‚ñº Atenci√≥n</span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-2 text-center text-gray-600">{{ tech.solicitudes }}</td>
                            <td class="py-2 px-2 text-center text-gray-600">{{ tech.ofertas }}</td>
                            <td
                                class="py-2 px-2 text-center {% if tech.pct_interno >= 90 %}text-green-600{% elif tech.pct_interno >= 85 %}text-amber-600{% else %}text-red-600{% endif %}">
                                {{ tech.pct_interno }}%
                            </td>
                            <td
                                class="py-2 px-2 text-center font-bold {% if tech.pct_compromiso >= 90 %}text-green-600{% elif tech.pct_compromiso >= 85 %}text-amber-600{% else %}text-red-600{% endif %}">
                                {{ tech.pct_compromiso }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {# ============================================ #}
        {# SECCI√ìN 4: ESTACIONALIDAD (solo si >6 meses) #}
        {# ============================================ #}
        {% if resumen.mostrar_estacionalidad and resumen.mejor_mes %}
        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
            <h4 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-1">An√°lisis Estacional ({{
                resumen.meses_en_rango }} meses)</h4>
            <p class="text-gray-700 text-sm">
                Mejor desempe√±o: <strong>{{ resumen.mejor_mes.nombre }}</strong> ({{ resumen.mejor_mes.pct_compromiso
                }}%).
                {% if resumen.peor_mes %}
                Punto m√°s bajo: <strong>{{ resumen.peor_mes.nombre }}</strong> ({{ resumen.peor_mes.pct_compromiso }}%).
                {% endif %}
            </p>
        </div>
        {% endif %}

    </div>
</details>

{# ============================================ #}
{# SECCI√ìN: DESEMPE√ëO POR PERFIL #}
{# ============================================ #}
{% if resumen.categorias_usuarios %}
<div class="mt-8 border-t-2 border-gray-200 pt-6">
    <h3 class="text-xl font-bold text-gray-900 mb-4">
        Desempe√±o por Perfil de Impacto
    </h3>
    <p class="text-sm text-gray-600 mb-6">
        {# (Categorizaci√≥n seg√∫n naturaleza del trabajo para an√°lisis justo) - REMOVED #}
    </p>

    {# Alta Complejidad #}
    {% if resumen.categorias_usuarios.alta_complejidad %}
    <div class="mb-6">
        <h4 class="text-lg font-bold text-amber-700">
            üèÜ L√≠deres de Alta Complejidad
        </h4>

        {% for usuario in resumen.categorias_usuarios.alta_complejidad %}
        <div class="ml-4 mb-4 p-4 bg-amber-50 rounded-lg border-l-4 border-amber-500">
            <div class="font-semibold text-gray-900 mb-2">
                ‚Ä¢ {{ usuario.nombre }}:
                <span class="text-amber-700">
                    Score {{ "%.1f"|format(usuario.score.score_final * 100) }}/100
                </span>
                <span class="text-sm text-gray-600">(ponderado por complejidad)</span>
            </div>

            <div class="ml-4 text-sm text-gray-700 space-y-1">
                <div class="flex items-start">
                    <span class="w-4 mr-2">‚îú‚îÄ</span>
                    <span>
                        Entregas: <strong>{{ usuario.total_ofertas }}</strong>
                        ({{ usuario.licitaciones }} licitaciones,
                        {{ "%.1f"|format((usuario.licitaciones / usuario.total_ofertas) * 100) }}%)
                    </span>
                </div>
                <div class="flex items-start">
                    <span class="w-4 mr-2">‚îú‚îÄ</span>
                    <span>
                        Cumplimiento: <strong>{{ usuario.porcentaje_a_tiempo_compromiso }}%</strong> compromiso cliente,
                        <strong>{{ usuario.porcentaje_a_tiempo_interno }}%</strong> SLA interno
                    </span>
                </div>
                <div class="flex items-start">
                    <span class="w-4 mr-2">‚îî‚îÄ</span>
                    <span>
                        Retrabajos: <strong>{{ usuario.retrabajados }}</strong>
                        ({{ "%.1f"|format((usuario.retrabajados / usuario.total_ofertas) * 100) }}%)
                        {% if usuario.score.motivo_retrabajo_principal %}
                        - Principal: "{{ usuario.score.motivo_retrabajo_principal }}"
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# Eficiencia #}
    {% if resumen.categorias_usuarios.eficiencia %}
    <div class="mb-6">
        <h4 class="text-lg font-bold text-blue-700">
            ‚ö° L√≠deres de Eficiencia
        </h4>

        {% for usuario in resumen.categorias_usuarios.eficiencia %}
        <div class="ml-4 mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
            <div class="font-semibold text-gray-900 mb-2">
                ‚Ä¢ {{ usuario.nombre }}:
                <span class="text-blue-700">
                    Score {{ "%.1f"|format(usuario.score.score_final * 100) }}/100
                </span>
            </div>

            <div class="ml-4 text-sm text-gray-700 space-y-1">
                <div class="flex items-start">
                    <span class="w-4 mr-2">‚îú‚îÄ</span>
                    <span>
                        Entregas: <strong>{{ usuario.total_ofertas }}</strong>
                        ({{ usuario.licitaciones }} licitaciones,
                        {{ "%.1f"|format((usuario.licitaciones / usuario.total_ofertas) * 100) }}%)
                    </span>
                </div>
                <div class="flex items-start">
                    <span class="w-4 mr-2">‚îú‚îÄ</span>
                    <span>
                        Cumplimiento: <strong>{{ usuario.porcentaje_a_tiempo_compromiso }}%</strong> compromiso cliente,
                        <strong>{{ usuario.porcentaje_a_tiempo_interno }}%</strong> SLA interno
                    </span>
                </div>
                <div class="flex items-start">
                    <span class="w-4 mr-2">‚îî‚îÄ</span>
                    <span>
                        Retrabajos: <strong>{{ usuario.retrabajados }}</strong>
                        ({{ "%.1f"|format((usuario.retrabajados / usuario.total_ofertas) * 100) }}%)
                        {% if usuario.score.motivo_retrabajo_principal %}
                        - Principal: "{{ usuario.score.motivo_retrabajo_principal }}"
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}

        {# Nota explicativa - SOLO si hay Alta Complejidad #}
        {% if resumen.mostrar_nota_alta_complejidad %}
        <div class="mt-4 p-4 bg-amber-50 rounded-lg border-l-4 border-amber-400">
            <p class="text-sm text-amber-900">
                <strong>‚ÑπÔ∏è Nota sobre "Alta Complejidad":</strong><br>
                Esta categor√≠a reconoce usuarios que trabajan proyectos estrat√©gicos con un alto volumen de licitaciones
                (‚â•{{ "%.1f"|format(resumen.umbral_licitaciones_pct) }}%, siendo el promedio global del periodo
                <strong>{{ "%.1f"|format(resumen.ratio_licitaciones_global) }}%</strong>).
                Estos proyectos requieren mayor tiempo de elaboraci√≥n y tienen
                requisitos formales m√°s estrictos.
            </p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# En Evaluaci√≥n #}
    {% if resumen.categorias_usuarios.evaluacion %}
    <div class="mb-6">
        <h4 class="text-lg font-bold text-gray-600">
            üìä Otros Colaboradores
        </h4>

        {% for usuario in resumen.categorias_usuarios.evaluacion %}
        <div class="ml-4 mb-3 text-sm text-gray-700">
            ‚Ä¢ <strong>{{ usuario.nombre }}</strong>:
            {{ usuario.total_ofertas }} entrega{% if usuario.total_ofertas != 1 %}s{% endif %} completada{% if
            usuario.total_ofertas != 1 %}s{% endif %}
            ({{ usuario.porcentaje_a_tiempo_compromiso }}% cumplimiento)
        </div>
        {% endfor %}

        <p class="ml-4 text-xs text-gray-500 italic mt-2">
            Nota: Se requieren al menos 10 entregas para c√°lculo de score de desempe√±o.
        </p>
    </div>
    {% endif %}

</div>
{% endif %}