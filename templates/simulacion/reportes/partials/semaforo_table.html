{# templates/simulacion/reportes/partials/semaforo_table.html #}
{# Tabla de contabilización por tipo de solicitud con semáforos #}

<div class="overflow-x-auto">
    <table class="w-full text-sm">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo de Solicitud</th>
                <th class="px-4 py-3 text-center font-semibold text-gray-700">Total</th>
                <th class="px-4 py-3 text-center font-semibold text-gray-700">En Plazo</th>
                <th class="px-4 py-3 text-center font-semibold text-gray-700">Fuera de Plazo</th>
                <th class="px-4 py-3 text-center font-semibold text-gray-700">Sin Fecha</th>
                <th class="px-4 py-3 text-center font-semibold text-gray-700">% Cumplimiento</th>
                <th class="px-4 py-3 text-center font-semibold text-gray-700">Estado</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for fila in filas %}
            {% if fila.total > 0 %}
            <tr class="hover:bg-gray-50 transition-colors {% if fila.es_levantamiento %}bg-blue-50{% endif %}">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        {% if fila.es_levantamiento %}
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">LEV</span>
                        {% endif %}
                        <span class="font-medium text-gray-900">{{ fila.nombre }}</span>
                    </div>
                    {% if fila.es_levantamiento %}
                    <p class="text-xs text-gray-500 mt-1">No cuenta para KPI de entregas</p>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="font-bold text-gray-900">{{ fila.total }}</span>
                </td>
                <td class="px-4 py-3 text-center">
                    {% if not fila.es_levantamiento %}
                    <span class="font-semibold text-green-600">{{ fila.en_plazo }}</span>
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                    {% if not fila.es_levantamiento %}
                    <span class="font-semibold text-red-600">{{ fila.fuera_plazo }}</span>
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                    {% if not fila.es_levantamiento %}
                    <span class="font-semibold text-gray-500">{{ fila.sin_fecha }}</span>
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                    {% if not fila.es_levantamiento %}
                    <span class="font-bold text-{{ fila.semaforo }}-600">
                        {{ fila.porcentaje_en_plazo }}%
                    </span>
                    {% else %}
                    <span class="text-gray-400">N/A</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                    {% if fila.es_levantamiento %}
                    {# Semáforo gris para levantamientos #}
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-200"
                        title="No aplica KPI">
                        <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                    </span>
                    {% else %}
                    {# Semáforo dinámico #}
                    <span
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-{{ fila.semaforo }}-100"
                        title="{{ fila.semaforo_label }}">
                        <span class="w-3 h-3 rounded-full bg-{{ fila.semaforo }}-500 animate-pulse"></span>
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="bg-gray-100 font-bold">
                <td class="px-4 py-3 text-gray-700">TOTAL</td>
                <td class="px-4 py-3 text-center text-gray-900">
                    {{ filas|map(attribute='total')|sum }}
                </td>
                <td class="px-4 py-3 text-center text-green-600">
                    {{ filas|selectattr('es_levantamiento', 'false')|map(attribute='en_plazo')|sum }}
                </td>
                <td class="px-4 py-3 text-center text-red-600">
                    {{ filas|selectattr('es_levantamiento', 'false')|map(attribute='fuera_plazo')|sum }}
                </td>
                <td class="px-4 py-3 text-center text-gray-500">
                    {{ filas|selectattr('es_levantamiento', 'false')|map(attribute='sin_fecha')|sum }}
                </td>
                <td class="px-4 py-3 text-center" colspan="2">-</td>
            </tr>
        </tfoot>
    </table>
</div>

{# Leyenda de semáforos #}
<div class="mt-4 flex flex-wrap items-center gap-6 text-xs text-gray-600">
    <span class="font-semibold">Leyenda:</span>

    {% set u = filas[0].umbrales_compromiso if filas and filas[0].umbrales_compromiso else None %}

    {% if u %}
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-{{ u.color_excelente }}-500"></span>
        <span>Excelente: &ge; {{ u.umbral_excelente }}%</span>
    </div>
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-{{ u.color_bueno }}-500"></span>
        <span>Bueno: &ge; {{ u.umbral_bueno }}%</span>
    </div>
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-{{ u.color_critico }}-500"></span>
        <span>Crítico: &lt; {{ u.umbral_bueno }}%</span>
    </div>
    {% else %}
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-green-500"></span>
        <span>Verde: &ge; {{ umbral_verde_interno }}%</span>
    </div>
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-amber-500"></span>
        <span>Ámbar: &ge; {{ umbral_ambar_interno }}% y &lt; {{ umbral_verde_interno }}%</span>
    </div>
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-red-500"></span>
        <span>Rojo: &lt; {{ umbral_ambar_interno }}%</span>
    </div>
    {% endif %}

    <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-gray-400"></span>
        <span>Gris: No aplica (Levantamientos)</span>
    </div>
</div>