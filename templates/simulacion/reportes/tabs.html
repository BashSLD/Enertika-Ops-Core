<script>
    function reportesDashboard() {
        return {
            filtros: {
                fecha_inicio: '',
                fecha_fin: '',
                tecnologia: '',
                usuario: ''
            },
            charts: {},
            graficasData: JSON.parse('{{ graficas | tojson | safe }}'),

            init() {
                console.log("Initializing Dashboard Charts");
                console.log("Graficas Data:", this.graficasData);
                this.$nextTick(() => {
                    this.renderCharts();
                });
            },

            renderCharts() {
                // Destroy existing charts if any to prevent canvas duplication/memory leaks
                Object.values(this.charts).forEach(c => c.destroy());
                this.charts = {};

                if (!this.graficasData) {
                    console.error("No graficasData found!");
                    return;
                }

                console.log("Rendering charts with keys:", Object.keys(this.graficasData));

                // Initialize charts
                this.initChart('chart-estatus', this.graficasData.estatus_pie, 'estatus');
                this.initChart('chart-mensual', this.graficasData.mensual_bar, 'mensual');
                this.initChart('chart-tecnologia', this.graficasData.tecnologia_pie, 'tecnologia');
                this.initChart('chart-kpi', this.graficasData.kpi_bar, 'kpi');
                this.initChart('chart-motivos', this.graficasData.motivos_bar, 'motivos');
            },

            initChart(canvasId, data, key) {
                const ctx = document.getElementById(canvasId);
                if (!ctx || !data) return;

                this.charts[key] = new Chart(ctx, {
                    type: data.tipo,
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        ...data.opciones,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 8
                                }
                            }
                        }
                    }
                });
            },

            aplicarFiltros() {
                const params = new URLSearchParams({
                    fecha_inicio: this.filtros.fecha_inicio,
                    fecha_fin: this.filtros.fecha_fin,
                    id_tecnologia: this.filtros.tecnologia,
                    responsable_id: this.filtros.usuario
                }).toString();

                htmx.ajax('GET', '/simulacion/partials/graphs?' + params, {
                    target: '#sim-tab-content',
                    swap: 'innerHTML'
                });
            },

            limpiarFiltros() {
                htmx.ajax('GET', '/simulacion/partials/graphs', {
                    target: '#sim-tab-content',
                    swap: 'innerHTML'
                });
            },

            formatDateRange() {
                if (!this.filtros.fecha_inicio) return '';
                // Simple formatting assuming ISO strings YYYY-MM-DD
                return `${this.filtros.fecha_inicio} - ${this.filtros.fecha_fin}`;
            }
        }
    }
</script>

<div id="reportes-container" class="space-y-6" x-data="{
    ...reportesDashboard(),
    isGeneratingPdf: false,
    async generarPDF() {
        this.isGeneratingPdf = true;
        try {
            const chartImages = {};
            // Captura segura de charts existentes
            if (this.charts.estatus) chartImages.estatus = this.charts.estatus.toBase64Image();
            if (this.charts.mensual) chartImages.mensual = this.charts.mensual.toBase64Image();
            if (this.charts.tecnologia) chartImages.tecnologia = this.charts.tecnologia.toBase64Image();
            if (this.charts.kpi) chartImages.kpi = this.charts.kpi.toBase64Image();
            if (this.charts.motivos) chartImages.motivos = this.charts.motivos.toBase64Image();

            const response = await fetch('/simulacion/reportes/pdf/generar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filtros: this.filtros,
                    charts: chartImages
                })
            });

            if (!response.ok) throw new Error('Error generando PDF');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Reporte_Simulacion_${this.filtros.fecha_inicio}_${this.filtros.fecha_fin}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (e) {
            console.error(e);
            alert('Error al generar el PDF: ' + e.message);
        } finally {
            this.isGeneratingPdf = false;
        }
    }
}"
    x-init="filtros.fecha_inicio='{{ filtros_aplicados.fecha_inicio }}'; filtros.fecha_fin='{{ filtros_aplicados.fecha_fin }}'">

    <!-- Overlay de Carga Dashboard -->
    <div id="loading-overlay-dashboard"
        class="htmx-indicator hidden absolute inset-0 bg-white/60 backdrop-blur-[2px] z-50 flex items-center justify-center rounded-xl transition-all duration-300">
        <div
            class="bg-white px-6 py-4 rounded-full shadow-xl border border-blue-100 flex items-center gap-3 transform scale-100 animate-in fade-in zoom-in duration-200">
            <svg class="animate-spin h-5 w-5 text-[#00BABB]" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span class="font-medium text-gray-700 tracking-wide">Cargando Análisis Detallado...</span>
        </div>
    </div>
    <!-- HEADER -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <svg class="w-7 h-7 text-[#00BABB]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Reportes de Simulación
                </h1>
                <p class="text-sm text-gray-500 mt-1">Periodo: <span class="font-medium"
                        x-text="formatDateRange()"></span></p>
            </div>

            <!-- NUEVO: Botón Análisis Detallado -->


            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-2">
                    <input type="date" x-model="filtros.fecha_inicio" @change="aplicarFiltros()"
                        class="text-sm border-gray-300 rounded-md focus:ring-[#00BABB]">
                    <span class="text-gray-400">-</span>
                    <input type="date" x-model="filtros.fecha_fin" @change="aplicarFiltros()"
                        class="text-sm border-gray-300 rounded-md focus:ring-[#00BABB]">
                </div>
                <select x-model="filtros.tecnologia" @change="aplicarFiltros()"
                    class="text-sm border-gray-300 rounded-lg focus:ring-[#00BABB]">
                    <option value="">Todas las Tecnologías</option>
                    {% for tech in catalogos.tecnologias %}<option value="{{ tech.id }}">{{ tech.nombre }}</option>{%
                    endfor %}
                </select>
                <select x-model="filtros.usuario" @change="aplicarFiltros()"
                    class="text-sm border-gray-300 rounded-lg focus:ring-[#00BABB]">
                    <option value="">Todos los Usuarios</option>
                    {% for user in catalogos.usuarios %}<option value="{{ user.id_usuario }}">{{ user.nombre }}</option>
                    {% endfor %}
                </select>
                <button @click="limpiarFiltros()"
                    class="text-sm text-gray-500 hover:text-red-500 underline">Limpiar</button>

                {% if role in ['ADMIN', 'MANAGER'] %}
                <a href="/simulacion/reportes/analisis-detallado" hx-get="/simulacion/reportes/analisis-detallado"
                    hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    hx-indicator="#loading-overlay-dashboard"
                    class="flex items-center gap-2 px-4 py-2 bg-[#123456] text-white rounded-lg hover:bg-[#0d2440] text-sm font-medium transition-colors duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span>Analisis Detallado</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div id="kpis-container">{% include "simulacion/reportes/partials/kpis_cards.html" %}</div>

    <!-- GRÁFICAS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribución por Estatus</h3>
            <div class="h-64"><canvas id="chart-estatus"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Solicitudes por Mes</h3>
            <div class="h-64"><canvas id="chart-mensual"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Por Tecnología</h3>
            <div class="h-64"><canvas id="chart-tecnologia"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Entregas: A Tiempo vs Fuera de Plazo</h3>
            <div class="h-64"><canvas id="chart-kpi"></canvas></div>
        </div>
    </div>

    <!-- TABS MANTENIDOS SOLO PARA MOTIVOS (OPCIONAL) O ELIMINADOS SI NO SON NECESARIOS EN DASHBOARD SIMPLE -->
    <!-- Se eliminan las tablas detalladas de aquí -->

    <div id="modal-container"></div>
</div>